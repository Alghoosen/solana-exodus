---
title: 포크 생성
---

해당 섹션은 [leader rotation](leader-rotation.md)을 통해 어떻게 포크가 자연스럽게 발생하는지 설명합니다.

## 개요

노드들은 순서대로 리더를 맡으며 상태 변화를 암호화한 역사증명을 생성합니다. 클러스터와 리더 간 연결이 단절된 경우, 리더는 연결되어 있으나 어떠한 상태 변화도 받아들이지 못할 때 _**생성했을**_ 결과물을 합성해내며 클러스터는 이를 감내할 수 있습니다. 그러므로 가능한 포크의 수는 리더 순환 슬롯 범위 안에서 발생될 수 있는 "있다/없다"의 포크 스킵 리스트로 한정됩니다. 어떠한 슬롯에서든지, 오직 단일 리더의 트랜잭션들만 받아들여 집니다.

## 메시지 흐름

1. 현 리더는 트랜잭션들을 받아들입니다.
2. 리더는 유효한 트랜잭션들을 필터링 합니다.
3. 리더는 유효한 트랜잭션들을 실행하며 상태를 업데이트 합니다.
4. 리더는 트랜잭션들을 역사증명 슬롯에 기반한 엔트리로 패키지화 합니다.
5. 리더는 엔트리를 밸리데이터 노드들에게 전파합니다 \(서명된채로\)
   1. 역사증명 스트림은 틱을 포함합니다; 틱은 클러스터 상 리더의 라이브니스와 시간 경과를 나타내는 비어있는 엔트리 입니다.
   2. 리더의 스트림은 해당 리더로부터 가장 최근으로 볼 수 있는 이전 리더의 슬롯으로 향하는 역사증명 완성에 필요한 틱 엔트리와 함께 시작됩니다.
6. 밸리데이터들은 자신들의 세트 내 피어들과 더 하위에 위치한 노드들에게 엔트리를 재전파 합니다.
7. 밸리데이터들은 트랜잭션들을 검증하고 자신들의 상태에서 실행합니다.
8. 밸리데이터들은 상태의 해시를 산출합니다.
9. 특정 역사증명 틱 카운터 등, 특정 시기마다 밸리데이터들은 리더에게 투표를 전송합니다.
   1. 표는 역사증명 틱 카운터에서 산출된 상태의 해시에 대한 서명입니다.
   2. 표는 또한 가십을 통해 전파됩니다.
10. 리더는 여느 트랜잭션과 같이 투표를 실행하고 클러스터에 이를 전파합니다.
11. 밸리데이터들은 자신들과 클러스터 상 모든 표를 확인합니다.

## 파티션, 포크

투표가 발생한 역사증명 틱 카운터 때 포크가 발생할 수 있습니다. 다음 리더는 이전 슬롯의 투표를 관찰하지 못했을 수도 있고 가상의 역사증명 엔트리를 생성하며 자신의 슬롯을 시작할 수도 있습니다. 이러한 비어있는 틱들은 클러스터 설정 상 틱 당 해시율인 `Z`의 속도로 모든 클러스터 상 노드들로부터 생성됩니다.

투표 슬롯에서 역사증명은 오직 두가지 버전만 생성 가능합니다: `T`개의 틱을 가진 역사증명과 현 리더가 생성한 엔트리이거나, 그저 틱만 가지는 역사증명이 있습니다. 그저 "틱만" 있는 버전의 역사증명은 가상 원장으로 볼 수 있으며, 클러스터 상 모든 노드들이 이전 슬롯의 마지막 틱으로부터 파생시킬 수 있는 것입니다.

밸리데이터들은 다른 시점에서 발생한 포크를 무시하거나 \(e.g. 잘못된 리더 등\), 포크에 책임이 있는 리더에게 슬래싱을 가합니다.

밸리데이터들은 [Tower BFT](../implemented-proposals/tower-bft.md)에서 설명하는 대로 자신들의 보상을 극대화할 수 있는 방향으로 투표를 진행합니다.

### 밸리데이터 시점

#### 시간 진척

아래 다이어그램은 밸리데이터의 시각에서 본 포크 가능한 역사증명 스트림을 나타냅니다. L1, L2 등은 리더 슬롯이며, `E`는 리더의 슬롯 동안 해당 리더가 발생시킨 엔트리들을 뜻합니다. `x`는 틱만을 나타내며, 다이어그램 상 시간은 아래로 흐릅니다.

![포크 생성](/img/fork-generation.svg)

동일한 슬롯 상 두 포크에서 나타나는 `E`는 슬래싱 가능한 상태이며, `E3`와 `E3`를 지켜보는 밸리데이터는 L3를 슬래싱하고 해당 슬롯에서 안전하게 `x`를 선택할 수 있습니다. 밸리데이터가 하나의 포크에 전념한다면 해당 틱 카운터 이하 나머지 포크들은 버려집니다. 어떤 슬롯에건 밸리데이터는 오직 "엔트리 있는" 체인이나 리더가 제안할 "틱만 있는" 체인 중 하나만 고려하면 됩니다. 그러나 이전 슬롯으로 연결되며 다수의 가상 엔트리가 겹칠 수 있습니다.

#### 시간 분할

역사증명 틱 카운터 상 리더 순환은 클러스터 상태 암호화 작업에 대한 시간 분할로 생각해 볼 수 있습니다. 아래 테이블은 위 포크 트리를 시간별로 분할된 원장화 한 것입니다.

| 리더 슬롯     | L1  | L2  | L3  | L4  | L5  |
| :------------ | :-- | :-- | :-- | :-- | :-- |
| 데이터        | E1  | E2  | E3  | E4  | E5  |
| 이전부터의 틱 |     |     |     | x   | xx  |

L3의 리더로부터 오는 데이터는 리더 슬롯 L3 동안만 받아들어 집니다. L3부터의 데이터는 L3가 L2의 데이터를 관찰하지 않았을 경우 L2가 아닌 다른 슬롯으로 향하는 "캐치업" 틱을 내포할 수 있습니다. L4와 L5의 전파는 "이전부터의 틱"을 지닌 역사증명 엔트리를 지닙니다.

이러한 네트워크 데이터 스트림 구성은 노드들이 이를 재현, 재시작, 체크포인트로서 활용할 수 있도록 원장에 저장할 수 있도록 해줍니다.

### 리더 시점

새로운 리더가 슬롯을 시작할 때, 리더는 가장 최근으로 볼 수 있는 투표된 슬롯에 대한 신규 슬롯 연결에 요구되는 아무 역사증명 \(틱\) 을 전파해야 합니다. 리더가 제안하는 포크는 현 슬롯을 리더가 가상의 틱으로 투표한 이전 포크와 연결합니다.
