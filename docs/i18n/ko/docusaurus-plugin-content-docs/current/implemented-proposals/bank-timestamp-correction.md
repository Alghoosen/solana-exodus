---
title: 은행 타임스탬프 수정
---

각 은행에는 Clock sysvar에 저장되고 시간 기반 지분 계정 잠금을 평가하는 데 사용되는 타임스탬프가 있습니다. 그러나 처음부터이 값은 현실이 아닌 이론적 인 초당 슬롯 수를 기반으로했기 때문에 매우 정확하지 않습니다. 잠금이 만료되도록 설정된 날짜에 계정이 잠금 해제로 등록되지 않기 때문에 잠금 문제가 발생합니다.

블록 시간은 이미 \[validator timestamp oracle\] (validator-timestamp-oracle.md); 이 데이터는 은행 타임스탬프를 실제 시간과 더 가깝게 맞출 수있는 기회를 제공합니다.

제안 된 구현의 일반적인 개요는 다음과 같습니다.

- -밸리데이터이 제공 한 타임스탬프를 사용하여 각 은행 타임스탬프를 수정합니다.
- Update the validator-provided timestamp calculation to use a stake-weighted median, rather than a stake-weighted mean.
- -예상되는 이론적 추정치에서 너무 멀어지지 않도록 타임스탬프 수정을 바인딩합니다.

## 타임스탬프 수정

모든 새로운 Bank에서 런타임은 밸리데이터 타임스탬프-오라클 데이터를 사용하여 현실적인 타임스탬프 추정치를 계산합니다. Bank 타임스탬프는 이전 Bank의 타임스탬프보다 크거나 같은 경우이 값으로 수정됩니다. 즉, 잠긴 계정이 수정에 의해 해제 될 수 있도록 시간이 뒤로 돌아가서는 안되지만 일단 해제되면 시간 수정으로 계정을 다시 잠글 수 없습니다.

### 스테이킹 가중치 중앙값 타임스탬프 계산

특정 은행의 예상 타임스탬프를 계산하려면 먼저 런타임이 활성 밸리데이터 세트에서 가장 최근의 투표 타임스탬프를 가져와야합니다. `Bank :: vote_accounts ()`메소드는 투표 계정 상태를 제공하며, 마지막 에포크 내에 가장 최근 타임스탬프가 제공된 모든 계정으로 필터링 될 수 있습니다.

각 투표 타임스탬프에서 현재 뱅크에 대한 추정치는 뱅크 슬롯과 타임스탬프 슬롯 사이의 델타에 대한 에포크의 대상 ns_per_slot을 사용하여 계산됩니다. 각 타임스탬프 추정치는 해당 투표 계정에 위임 된 지분과 연관되며 모든 타임스탬프가 수집되어 지분 가중 타임스탬프 분포를 생성합니다.

이 세트에서 지분 가중 중앙 타임스탬프, 즉 지분의 50 %가 더 크거나 같은 타임스탬프를 추정하고 지분의 50 %가 더 작거나 같은 타임스탬프를 추정하는 타임스탬프가 선택됩니다.

평균 계산에서 제안 된 타임스탬프에 지분을 곱하면 지분이 매우 작은 노드가 매우 큰 타임스탬프를 제안함으로써 결과 타임스탬프에 여전히 큰 영향을 미칠 수 있기 때문에이 지분 가중치 중앙 타임스탬프는 지분 가중치 평균보다 선호됩니다. 예를 들어, 이전의`calculate_stake_weighted_timestamp ()`메서드를 사용하면 지분의 0.00003 %가`i64 :: MAX`의 타임스탬프를 제안하는 노드가 타임스탬프를 97,000 년 앞으로 이동할 수 있습니다!

### 경계 타임스탬프

In addition to preventing time moving backward, we can prevent malicious activity by bounding the corrected timestamp to an acceptable level of deviation from the theoretical expected time.

시간이 뒤로 이동하는 것을 방지하는 것 외에도 수정 된 타임스탬프를 이론적 예상 시간에서 허용 가능한 수준의 편차로 제한하여 악의적 인 활동을 방지 할 수 있습니다.

타임스탬프 편차를 계산하기 위해 각 Bank는 Clock sysvar에`epoch_start_timestamp`를 기록해야합니다. 이 값은 각 Epoch의 첫 번째 슬롯에서 'Clock :: unix_timestamp'로 설정됩니다.

그런 다음 런타임은 수정 된 타임스탬프를 기반으로 epoch 시작 이후 예상 경과 시간과 제안 된 경과 시간을 비교합니다. 수정 된 경과 시간이 예상의 +/- 25 % 이내이면 수정 된 타임스탬프가 허용됩니다. 그렇지 않으면 허용 가능한 편차에 제한됩니다.
