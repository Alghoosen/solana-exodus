---
title: تصحيح الختم الزمني للبنك (Bank Timestamp Correction)
---

يحتوي كل بنك على ختم زمني (Timestamp) يتم تخزينه في نظام الساعة ويستخدم لتقييم عمليات قفل حساب الأسهم المُستندة إلى الوقت. مع ذلك، مُنذ مرحلة التكوين (Genesis)، هذه القيمة كانت مبنية على نظرية فتحات كل ثانية (slots-per-second) بدلاً من الواقع، لذا فهي غير دقيقة تمامًا. يُمثل هذا مشكلة بالنسبة لعمليات الإقفال، نظرًا لأن الحسابات لن تُسجل على أنها خالية من القفل في (أو في أي وقت قريب) من تاريخ تعيين القفل على الإنتهاء.

يتم بالفعل تقدير أوقات الكتل (Block times) للتخزين المُؤقت في مخزن الكُتلة (blockstore) والتخزين طويل المدى بإستخدام أوراكل الختم الزمني للمُدقّق [validator timestamp oracle](validator-timestamp-oracle.md)؛ تُوفر هذه البيانات فرصة لمُواءمة الختم الزمني للبنك بشكل وثيق مع الوقت الفعلي.

المُخطط العام للتنفيذ المُقترح هو كما يلي:

- قُم بتصحيح كل ختم زمني (Timestamp) للبنك بإستخدام الختم زمني المُقدم من المُدقّق (validator).
- قُم بتحديث حساب الطابع الذي يوفره المُدقّق (validator) لإستخدام المُتوسط المُرجح بالحِصَّة (stake-weighted)، بدلاً من متوسط المُرجح بالحِصَّة (stake-weighted).
- أُربط تصحيح الختم الزمني (Timestamp) بحيث لا ينحرف كثيرًا عن التقدير النظري المُتوقع

## تصحيح الختم الزمني (Bank Timestamp)

في كل بنك جديد، يحسب وقت التشغيل تقديرًا واقعيًا للختم الزمني (Timestamp) بإستخدام بيانات الختم الزمني للأوراكل (timestamp-oracle) للمُدقّق (validator. يتم تصحيح الختم الزمني (Timestamp) للبنك إلى هذه القيمة إذا كانت أكبر من أو تُساوي الختم الزمني (Timestamp) للبنك السابق. هذا يعني أن الوقت لا ينبغي أن يتراجع أبدًا، لذلك قد يتم تحرير الحسابات المُقفلة من خلال التصحيح، ولكن بمجرد الإفراج عن الحسابات، لا يُمكن أبدًا إعادة تجميع الحسابات عن طريق تصحيح الوقت.

### حساب الختم الزمني المُتوسط المُرجح بالحِصَّة (Calculating Stake-Weighted Median Timestamp)

من أجل حساب الختم الزمني (Timestamp) المُقدر لبنك مُعين، يحتاج وقت التشغيل أولاً إلى الحصول على أحدث الأختام الزمنية (Timestamps) للتصويت من مجموعة المُدقّق (validator) النشط. تُوفر طريقة `Bank::vote_accounts()` حالة حسابات التصويت، ويُمكن تصفيتها لجميع الحسابات التي تم توفير تمها الزمني (Timestamp) الأخير خلال الفترة (epoch) الماضية.

من كل تصويت ختم زمني (Timestamp)، يتم حساب تقدير للبنك الحالي بإستخدام هدف الفترة ns_per_slot لأي دلتا (delta) بين فُتحة (Slot) البنك وفتحة الختم الزمني. يرتبط كل تقدير للختم الزمني (Timestamp) بالحِصَّة (stake) المُفوضة لحساب التصويت هذا، ويتم جمع كل الأختام الزمنية (Timestamps) لإنشاء توزيع أختام الزمنية مُرجحة بالحِصَّة (stake-weighted).

من هذه المجموعة، يتم تحديد مُتوسط الختم الزمني (Timestamp) المُرجح بالحِصَّة (stake-weighted) - أي الختم الزمني الذي تُقدر عنده 50٪ من الحِصَّة (stake) ختما زمنيًا أكبر أو يساوي ويُقدر 50٪ من الحِصَّة ختما زمنيًا أقل أو يساوي - يتم تحديده كختم زمني مُصحح مُحتمل.

يُفضل مُتوسط الختم الزمني (Timestamp) المُرجح بالحِصَّة (stake-weighted) هذا على المُتوسط المُرجح بالحِصَّة لأن مُضاعفة الحِصَّة بالختم الزمني المُقترح في الحساب يسمح للعُقدة (node) ذات الحِصَّة الصغيرة جدًا أن يكون لها تأثير كبير على الختم الزمني الناتج من خلال إقتراح ختم زمني كبير جدًا أو صغير جدًا. على سبيل المثال، بإستخدام طريقة `calculate_stake_weighted_timestamp()` السابقة، يُمكن للعُقدة (node) التي بها 0.00003٪ من الحِصَّة (stake) التي تقترح ختما زمنيا (Timestamp) بقيمة `i64::MAX` أن تُحول الختم الزمني (Timestamp) إلى الأمام بـ 97 ألف سنة!

### الطوابع الزمنية الممُضمّنة (Bounding Timestamps)

بالإضافة إلى منع تحرك الوقت للخلف، يُمكننا منع النشاط الضار من خلال ربط الختم الزمني (Timestamp) المُصحح بمستوى مقبول من الإنحراف عن الوقت النظري المُتوقع.

يقترح هذا الإقتراح السماح لكل ختم زمني (Timestamp) بالإنحراف بنسبة تصل إلى 25٪ عن الوقت المُتوقع منذ بداية الفترة (epoch).

لحساب إنحراف الختم الزمني (Timestamp)، يحتاج كل بنك إلى تسجيل `epoch_start_timestamp` في نظام الساعة sysvar. يتم تعيين هذه القيمة على `Clock::unix_timestamp` في الفُتحة (slot) الأولى من كل فترة (epoch).

بعد ذلك، يُقارن وقت التشغيل الوقت المُنقضي المُتوقع مُنذ بداية الفترة (epoch) مع الوقت المُنقضي المُقترح بناءً على الختم الزمني (Timestamp) المُصحح. إذا كان الوقت المُنقضي المُصحح ضمن +/- 25٪ من المُتوقع، يتم قبول الختم الزمني (Timestamp) المُصحح. بخلاف ذلك، يتم تقييده بالإنحراف المقبول.
