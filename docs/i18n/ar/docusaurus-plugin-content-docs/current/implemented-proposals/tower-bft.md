---
title: بُرج BFT أو Tower BFT
---

يصف هذا التصميم خوارزمية الـ _Tower BFT_ الخاصة بـ Solana. وهو يُعالج المشاكل التالية:

- قد لا يتم قبول بعض الإنقسامات أو الشوكات (forks) في نهاية المطاف من قبل الأغلبية العظمى للمجموعة (cluster)، ويحتاج الناخبون (voters) إلى التعافي من التصويت على هذه الإنقسامات أو الشوكات.
- قد تكون العديد من الإنقسامات أو الشوكات قابلة للتصويت من قبل ناخبين مُختلفين، وقد يرى كل ناخب مجموعة مُختلفة من الإنقسامات أو الشوكات القابلة للتصويت. يجب أن تتلاقى الإنقسامات أو الشوكات المُحددة في النهاية مع المجموعة (cluster).
- الأصوات القائمة على المُكافأة لها مخاطر مُرتبطة بها. يجب أن يتمتع الناخبون بالقدرة على تحديد مقدار المُخاطرة التي يتعرضون لها.
- تحتاج تكلفة التراجع [cost of rollback](tower-bft.md#cost-of-rollback) إلى أن تكون قابلة للحساب. من المُهم للعملاء الذين يعتمدون على شكل من أشكال الإتساق القابلة للقياس. يجب أن تكون تكاليف كسر الإتساق قابلة للحساب، وأن تزداد بشكل أُحادي الإتجاه للغاية (super-linearly) بالنسبة للأصوات الأقدم.
- تختلف سرعات الـ ASIC بين العُقد (nodes)، ويُمكن للمُهاجمين إستخدام إثبات التاريخ (Proof of History) للـ ASICS الذي يكون أسرع بكثير من بقية المجموعة (cluster). يجب أن يكون الإجماع مُقاومًا للهجمات التي تستغل التباين في سرعة إثبات التاريخ للـ ASIC.

للإيجاز، يفترض هذا التصميم أن ناخبًا (voter) واحدًا له حِصَّة (stake) يتم نشره كمُدقّق (validators) فردي في الكتلة (cluster).

## الوقت (Time)

تُنشئ المجموعة (cluster) الخاصة بـSolana مصدرًا للوقت عبر وظيفة تأخير يُمكن التحقُّق منها (Verifiable Delay Function) ندعوها بإثبات التاريخ [Proof of History](../cluster/synchronization.md).

يتم إستخدام إثبات التاريخ (Proof of History) لإنشاء جدول روبن زمني (round robin schedule) حتمي لجميع القادة (leaders) النشطين. في أي وقت، يُمكن لقائد واحد فقط، والذي يُمكن حسابه من دفتر الأستاذ (ledger) نفسه، إقتراح إنقسام أو شوكة (fork). لمزيد من التفاصيل، راجع إنشاء الإنقسام أو الشوكة [fork generation](../cluster/fork-generation.md) و التناوب على القيادة [leader rotation](../cluster/leader-rotation.md).

## الإغلاقات (Lockouts)

الغرض من الإغلاقات هو إجبار المُدقّق (validator) على الإلتزام بتكلفة الفرصة البديلة لإنقسام أو شوكة (fork) مُعينة. يتم قياس عمليات الإغلاقات في الفتحات (slots)، وبالتالي تُمثل تأخيرًا إجباريًا في الوقت الفعلي حيث يحتاج المُدقّق (validator) إلى الإنتظار قبل كسر الإلتزام بالإنقسام أو الشوكة (fork).

يجب مُعاقبة المُدقّقين (validators) الذين ينتهكون عمليات الإغلاقات ويُصوتون لإنقسام أو شوكة (fork) مُتباينة داخل التأمينات. العقوبة المُقترحة هي الإقتطاع من حِصَّة (stake) المُدقّق (validator) إذا كان من المُمكن إثبات تصويت مُتزامن داخل إغلاق إنقسام أو شوكة (fork) غير تابعة للمجموعة (cluster).

## الخوارزمية (Algorithm)

الفكرة الأساسية لهذا النهج هي تكديس الأصوات بالإجماع (consensus) والإغلاق المزدوج. كل تصويت في المُكدس (stack) هو تأكيد للإنقسام أو الشوكة (fork). كل إنقسام أو شوكة (fork) مُؤكدة هي سلف الإنقسام أو الشوكة التي تعلوها. يحتوي كل تصويت على إغلاق `lockout` في وحدات الفُتحات (Slots) قبل أن يتمكن المُدقّق (validator) من إرسال تصويت لا يحتوي على الإنقسام أو الشوكة (fork) المُؤكدة كجد (ancestor).

عند إضافة تصويت إلى المُكدس (stack)، تتم مُضاعفة عمليات الإغلاق لجميع الأصوات السابقة في المُكدس (المزيد عن هذا في [Rollback](tower-bft.md#Rollback)\). مع كل تصويت جديد، يقوم المُدقّق (validator) بإلزام الأصوات السابقة بإغلاق مُتزايد بإستمرار. عند 32 صوتًا، يمكننا إعتبار أن التصويت يبلغ الحد الأقصى للإغلاقات `max lockout` أي صوت مع إغلاق يُساوي أو يزيد عن `1<<32` يتم إلغاء ترتيبهم \(FIFO\). إلغاء (Dequeuing) التصويت هو الدافع وراء المُكافأة. إذا إنتهت صلاحية التصويت قبل أن يتم إلغاء ترتيبه (dequeued)، فسيتم إخراجه وجميع الأصوات فوقه \(LIFO\) من حزمة التصويت (vote stack). يحتاج المُدقّق (validator) إلى البدء في إعادة بناء المُكدس (stack) من تلك النقطة.

### التراجع (Rollback)

قبل أن يتم دفع التصويت إلى المُكدس (stack)، يتم تفريق جميع الأصوات التي تسبق التصويت مع وقت إغلاق أقل من التصويت الجديد. بعد أن لا يتم مُضاعفة عمليات التراجع عن الإغلاقات (rollback lockouts) حتى يلتحق المُدقّق (validator) بإرتفاع التراجع (rollback height) عن الأصوات.

على سبيل المثال ، حِزمة تصويت (vote stack) بالحالة التالية:

| التصويت (vote) | وقت التصويت (vote time) | الإغلاقات (Lockouts) | وقت إنتهاء الإغلاق (lock expiration time) |
| --------------:| -----------------------:| --------------------:| -----------------------------------------:|
|              4 |                       4 |                    2 |                                         6 |
|              3 |                       3 |                    4 |                                         7 |
|              2 |                       2 |                    8 |                                        10 |
|              1 |                       1 |                   16 |                                        17 |

التصويت _Vote 5_ في الوقت 9، والحالة الناتجة هي

| التصويت (vote) | وقت التصويت (vote time) | الإغلاقات (Lockouts) | وقت إنتهاء الإغلاق (lock expiration time) |
| --------------:| -----------------------:| --------------------:| -----------------------------------------:|
|              5 |                       9 |                    2 |                                        11 |
|              2 |                       2 |                    8 |                                        10 |
|              1 |                       1 |                   16 |                                        17 |

التصويت _Vote 6_ في الوقت 10

| التصويت (vote) | وقت التصويت (vote time) | الإغلاقات (Lockouts) | وقت إنتهاء الإغلاق (lock expiration time) |
| --------------:| -----------------------:| --------------------:| -----------------------------------------:|
|              6 |                      10 |                    2 |                                        12 |
|              5 |                       9 |                    4 |                                        13 |
|              2 |                       2 |                    8 |                                        10 |
|              1 |                       1 |                   16 |                                        17 |

في ذلك الوقت، عادت 10 أصوات جديدة إلى التصويت السابق. لكن تنتهي صلاحية التصويت _vote 2_ عند 10، لذلك عندما يتم تطبيق التصويت _vote 7_ في الوقت 11، ستظهر الأصوات بما في ذلك التصويت _vote 2_ وما فوقها.

| التصويت (vote) | وقت التصويت (vote time) | الإغلاقات (Lockouts) | وقت إنتهاء الإغلاق (lock expiration time) |
| --------------:| -----------------------:| --------------------:| -----------------------------------------:|
|              7 |                      11 |                    2 |                                        13 |
|              1 |                       1 |                   16 |                                        17 |

لن يزيد إغلاق (lockout) التصويت 1 من 16 حتى تحتوي المجموعة على 5 أصوات.

### الإقتطاع والمكافآت (Slashing and Rewards)

يجب مُكافأة المُدقّقين (validators) على إختيار الإنقسام أو الشوكة (fork) التي إختارتها بقية المجموعة (cluster) كلما أمكن ذلك. يتماشى هذا جيدًا مع الحصول على مُكافأة عندما يكون مجموع الأصوات ممتلئًا ويحتاج التصويت الأقدم إلى إلغاء الترتيب (dequeued). بالتالي يجب أن يتم إنشاء مُكافأة لكل إلغاء ترتيب (dequeued) ناجح.

### تكلفة التراجع (Cost of Rollback)

يتم تعريف تكلفة التراجع عن الإنقسام أو الشوكة _fork A_ على أنها التكلفة من حيث وقت الإغلاق للمُدقّق (validator) لتأكيد أي إنقسام أو شوكة أخرى لا يتضمن إنقسام أو شوكة _fork A_ كجد (ancestor).

يُمكن حساب النهائيّة الإقتصادية **Economic Finality** من الإنقسام أو الشوكة _fork A_ على أنها خسارة جميع المُكافآت من التراجع عن الإنقسام أو الشوكة _fork A_ وأحفادها (descendants)، بالإضافة إلى تكلفة الفرصة البديلة للمُكافأة بسبب الإغلاق المُتزايد بشكل كبير للأصوات التي أكدت الإنقسام أو الشوكة _fork A_.

### الحدود القصوى (Thresholds)

يُمكن لكل المُدقّق (validator) بشكل مُستقل تعيين عتبة إلتزام المجموعة (cluster) بالإنقسام أو الشوكة (fork) قبل أن يلتزم المُدقّق بالإنقسام أو الشوكة. على سبيل المثال، في مُؤشر تكديس حِزمة التصويت 7، يكون الإغلاق 256 وحدة زمنية. يجوز للمُدقّق (validator) حجب الأصوات والسماح للأصوات 0-7 بإنتهاء صلاحيتها ما لم يكن للتصويت في المُؤشر 7 إلتزام بنسبة تزيد عن 50٪ في المجموعة (cluster). يسمح هذا لكل مُدقّق (validator) بالتحكم بشكل مُستقل في مقدار المُخاطرة للإلتزام بالإنقسام أو الشوكة (fork). الإلتزام بالإنقسامات أو الشوكات (forks) بتردد أعلى سيسمح للمُدقّق (validator) بكسب المزيد من المُكافآت.

### مُعلِّمات الخوارزمية (Algorithm parameters)

يجب ضبط المُعلِّمات التالية:

- عدد الأصوات في المُكدس (stack) قبل حدوث إلغاء الترتيب \(32\).
- مُعدل نمو عمليات الإغلاق في المُكدس \(2x\).
- بدء الإغلاق المُفترض \(2\).
- عمق الحد الأقصى لإلتزام المجموعة (cluster) قبل الإلتزام بالإنقسام أو الشوكة \(8\).
- الحد الأدنى لحجم إلتزام المجموعة (cluster) عند الحد الأقصى \(50٪+\).

### الإختيار الحر (Free Choice)

"الإختيار الحر" هو إجراء المُدقّق (validator) الغير قابل للتنفيذ. لا توجد طريقة للبروتوكول لتشفير هذه الإجراءات وإنفاذها لأن كل مُدقّق (validator) يُمكنه تعديل الكود وضبط الخوارزمية. يجب أن يتصرف المُدقّق (validator) الذي يزيد المُكافأة الذاتية إلى أقصى حد على جميع العقود المُستقبلية (futures) المُحتملة بطريقة تجعل النظام مُستقرًا، ويجب أن يُؤدي إختيار الجشع المحلي إلى خيار جشع على جميع العقود المُستقبلية المُمكنة. يجب أن تلتزم مجموعة المُدقّقين (validators) الذين ينخرطون في إختيارات لتعطيل البروتوكول بوزن حِصّتهم (stake) في رفض الخدمة. يوجد خياران للمُدقّق (validator):

- يُمكن للمُدقّق (validator) تجاوز المُدقّق السابق في التوليد الظاهري وإرسال إنقسام أو شوكة (fork) مُتزامنة
- يمكن للمُدقّق (validator) حجب التصويت لمُلاحظة عدة إنقسامات أو شوكات (forks) قبل التصويت

في كلتا الحالتين، لدى المُدقّق (validator) في المجموعة (cluster) عدة إنقسامات أو شوكات (forks) للإختيار من بينها بشكل مُتزامن، على الرغم من أن كل إنقسام أو شوكة تُمثل إرتفاعًا مُختلفًا. في كلتا الحالتين، يستحيل على البروتوكول إكتشاف ما إذا كان سلوك المُدقّق (validator) مقصودًا أم لا.

### الإختيار الجشع للإنقسامات أو الشوكات المُتزامنة (Greedy Choice for Concurrent Forks)

عند تقييم عدة إنقسامات أو شوكات (forks)، يجب على كل مُدقّق (validator) إستخدام القواعد التالية:

1. يجب أن تفي الإنقسامات أو الشوكات بقاعدة الحد الأقصى _Threshold_.
2. اختر الإنقسام أو الشوكة (fork) التي تزيد من إجمالي وقت إغلاق المجموعة (cluster) لجميع إنقسامات أو شوكات السلف (ancestor).
3. إختر الإنقسام أو الشوكة (fork) التي تحتوي على أكبر قدر من رسوم مُعاملات المجموعة (cluster).
4. إختر أحدث إنقسام أو شوكة (fork) من حيث PoH.

رسوم مُعاملات المجموعة (cluster) هي الرسوم التي يتم إيداعها في مجمع التعدين (mining pool) كما هو مُوضح في قسم إثبات الحِصَّة أو التَّحْصِيص [Staking Rewards](staking-rewards.md).

## مقاومة الـ ASIC PoH أو PoH ASIC Resistance

تزداد الأصوات وعمليات الإغلاق بشكل كبير بينما يُسرع الـ ASIC بشكل أُحادي الإتجاه. هناك نوعان من ناقلات الهجوم (attack vectors) المُحتملة التي تتضمن ASIC أسرع.

### الرقابة على الـ ASIC أو ASIC censorship

يولد المُهاجم إنقسام أو شوكة (fork) مُتزامنة تتفوق على القادة (leaders) السابقين في مُحاولة لفرض رقابة عليهم. سيتوفر الإنقسام أو الشوكة (fork) التي إقترحها هذا المُهاجم بالتزامن مع القائد المُتاح التالي. بالنسبة للعُقد (nodes) التي تختار هذه الإنقسام أو الشوكة (fork)، يجب أن تفي بقاعدة الإختيار الجشع _Greedy Choice_.

1. يجب أن يكون للإنقسام أو الشوكة (fork) عدد متساوٍ من الأصوات للإنقسام أو الشوكة الأصل.
2. لا يمكن أن يكون للإنقسام أو الشوكة (fork) رأسًا حتى الآن لأنها تتسبب في إنتهاء صلاحية الأصوات.
3. يجب أن يكون لدى الإنقسام أو الشوكة (fork) مبلغ أكبر من رسوم مُعاملات المجموعة (cluster).

ثم يقتصر هذا الهجوم على فرض الرقابة على رسوم القادة السابقين والمُعاملات الفردية. لكن لا يُمكنه إيقاف المجموعة (cluster)، أو تقليل مجموعة المُدقّق (validator) مُقارنةً باالإنقسام أو الشوكة (fork) المُتزامنة. تقتصر رقابة الرسوم على رسوم الوصول التي تذهب للقادة (leaders) وليس المُدقّقين (validators).

### التراجع عن الـ ASIC أو ASIC Rollback

يُنشئ المُهاجم إنقسام أو شوكة (fork) مُتزامنة من كتلة قديمة لمُحاولة التراجع عن الكتلة (cluster). في هذا الهجوم، يتنافس الإنقسام أو الشوكة (fork) المُتزامنة مع الإنقسامات أو الشوكات التي تم التصويت عليها بالفعل. يقتصر هذا الهجوم على النمو المُتسارع لعمليات الإغلاق.

- عدد 1 صوت لديه إغلاق من فُتحتين (Slots). يجب أن تكون الشوكة المُتزامنة على الأقل بعدد 2 فُتحتين (slots) للأمام، وأن يتم إنتاجها في عدد 1 فُتحة (slot). لذلك يتطلب ASIC أسرع بمرتين.
- عدد 2 أصوات لديهم إغلاق من 4 فُتحات (slots). يجب أن يكون الإنقسام أو الشوكة (fork) المُتزامنة في المُقدمة بـ 4 فُتحات (Slots) على الأقل ويتم إنتاجها في عدد 2 فُتحات (slots). لذلك يتطلب ASIC أسرع بمرتين.
- عدد 3 أصوات لديهم إغلاق من 8 فُتحات (slots). يجب أن يكون الإنقسام أو الشوكة (fork) المُتزامنة في المُقدمة بـ 8 فُتحات (Slots) على الأقل ويتم إنتاجها في عدد 3 فُتحات (slots). لذلك يتطلب ASIC أسرع بـ 2.6 مرة.
- عدد 10 أصوات لديهم إغلاق من 1024 فُتحة (slots). ASIC بقوة 1024/10 أو ASIC أسرع بـ 102.4 مرة.
- عدد 20 صوت لديهم إغلاق من 2^20 فُتحة (slots). ASIC بقوة 2^20/20 أو ASIC أسرع بـ 52,428.8 مرة.
