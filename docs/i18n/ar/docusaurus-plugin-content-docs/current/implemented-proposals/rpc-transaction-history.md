# تاريخ مُعاملات RPC طويل المدى (Long term RPC Transaction History)

هناك حاجة إلى أن يخدم الـ RPC ما لا يقل عن 6 أشهر من سجل المُعاملات. السجل الحالي، بترتيب الأيام، غير كافٍ للمُستخدمين المُتلقين للمعلومات.

لا يُمكن تخزين 6 أشهر من بيانات المُعاملة عمليًا في دفتر الأستاذ rocksdb الخاص بالمُدقّق (validator)، لذا من الضروري وجود مخزن بيانات خارجي. سيستمر دفتر الأستاذ rocksdb الخاص بالمُدقّق في العمل كمصدر أساسي للبيانات، ثم يعود إلى مخزن البيانات الخارجي.

نقاط نهاية الـ RPC المُتأثرة هي:

- [getFirstAvailableBlock](developing/clients/jsonrpc-api.md#getfirstavailableblock)
- [getConrecmedBlock](developing/clients/jsonrpc-api.md#getconfirmedblock)
- [getConfirmedBlocks](developing/clients/jsonrpc-api.md#getconfirmedblocks)
- [getConfirmedSignaturesForAddress](developing/clients/jsonrpc-api.md#getconfirmedsignaturesforaddress)
- [getConfirmedTransaction](developing/clients/jsonrpc-api.md#getconfirmedtransaction)
- [getSignatureStatuses](developing/clients/jsonrpc-api.md#getsignaturestatuses)

لاحظ أن الحصول على وقت الكُتلة [getBlockTime](developing/clients/jsonrpc-api.md#getblocktime) غير مدعوم، لأنه بمُجرد إصلاح https://github.com/solana-labs/solana/issues/10089، يُمكن إزالة `getBlockTime`.

بعض قيود تصميم النظام:

- حجم البيانات المُراد تخزينها والبحث عنها يمكن أن يقفز بسرعة إلى terabytes، وهو غير قابل للتغيير.
- يجب أن يكون النظام خفيفًا قدر الإمكان بالنسبة لـ SREs. على سبيل المثال، فإن مجموعة قواعد بيانات الـ SQL التي تتطلب SRE لمُراقبة العُقد (nodes) وإعادة توازنها بإستمرار أمر غير مرغوب فيه.
- يجب أن تكون البيانات قابلة للبحث في الوقت الفعلي - الإستعلامات المُجمعة التي تستغرق دقائق أو ساعات لتشغيلها غير مقبولة.
- من السهل نسخ البيانات في جميع أنحاء العالم لتحديد موقعها مع نقاط نهاية RPC التي ستستخدمها.
- يجب أن يكون التفاعل مع مخزن البيانات الخارجي أمرًا سهلاً ولا يتطلب إعتمادًا على مُخاطرة قليلة الإستخدام لمكتبات التعليمات البرمجية المدعومة من المُجتمع

بناءً على هذه القيود، يتم تحديد مُنتج BigTable من Google كمخزن للبيانات.

## مُخطط الجدول (Table Schema)

يتم إستخدام مثيل BigTable للإحتفاظ بجميع بيانات المُعاملات، مُقسمة إلى جداول مُختلفة للبحث السريع.

قد يتم نسخ البيانات الجديدة إلى المثيل في أي وقت دون التأثير على البيانات الموجودة، وجميع البيانات غير قابلة للتغيير. بشكل عام، من المُتوقع أن يتم تحميل البيانات الجديدة بمجرد إكتمال الفترة (epoch) الحالية ولكن لا توجد قيود على تكرار تفريغ البيانات.

يتم تنظيف البيانات القديمة تلقائيًا عن طريق تكوين سياسة الإحتفاظ بالبيانات لجداول المثيل بشكل مُناسب ، وتختفي تمامًا. لذلك يُصبح ترتيب وقت إضافة البيانات مهمًا. على سبيل المثال، إذا تمت إضافة البيانات من الفترة (epoch) عدد N-1 بعد البيانات من الفترة عدد N، فإن بيانات الفترة الأقدم ستُعمر بعد البيانات الأحدث. مع ذلك، بخلاف إنتاج ثقوب _holes_ في نتائج الإستعلام، لن يكون لهذا النوع من الحذف غير المُرتب أي تأثير سيء. لاحظ أن طريقة التنظيف هذه تسمح بشكل فعال بتخزين كمية غير محدودة من بيانات المُعاملات، مُقيدة فقط بالتكاليف المالية للقيام بذلك.

يدعم تخطيط الجدول نقاط نهاية الـ RPC الموجودة فقط. قد تتطلب نقاط نهاية الـ RPC الجديدة في المُستقبل إضافات إلى المُخطط ومن المُحتمل أن تتكرر عبر جميع المُعاملات لإنشاء بيانات التعريف الضرورية.

## الولوج إلى BigTable

يحتوي BigTable على نقطة نهاية الـ gRPC يمكن الوصول إليها بإستخدام [tonic](https://crates.io/crates/crate)] وواجهة برمجة التطبيقات الأولية (API) الخاصة بـ protobuf، حيث لا يُوجد حاليًا صندوق Rust ذي مُستوى أعلى لـ BigTable. من الناحية العملية، يجعل هذا تحليل نتائج إستعلامات BigTable أكثر تعقيدًا ولكنه ليس مُشكلة مُهمة.

## بيانات المجتمع (Data Population)

سيحدث المُحتوى المُستمر لبيانات المثيل في إيقاع فترة (epoch) من خلال إستخدام الأمر `solana-ledger-tool` الجديد الذي سيحول بيانات rocksdb لنطاق فُتحة (Slot) مُعين إلى مُخطط المثيل.

سيتم تشغيل نفس العملية مرة واحدة يدويًا لإعادة تعبئة بيانات دفتر الأستاذ (ledger) الحالية.

### Block Table أو جدول الكتلة: `block`

يحتوي هذا الجدول على بيانات الكتلة (block) المضغوطة لفُتحة (Slot) مُعينة.

يتم إنشاء مفتاح الصف (row key) من خلال أخذ تمثيل سداسي عشري (hexadecimal) صغير مُكون من 16 رقمًا للفُتحة (Slot)، للتأكد من أن الفُتحة الأقدم ذات الكتلة (block) المؤكدة ستكون دائمًا أولًا عند إدراج الصفوف. على سبيل المثال، مفتاح الصف للفُتحة 42 سيكون 000000000000002a.

بيانات الصف مضغوطة بهيكلة `StoredConfirmedBlock`.

### جدول بحث توقيع مُعاملة عنوان الحساب: `tx-by-addr`

يحتوي هذا الجدول على المُعاملات التي تُؤثر على عنوان مُعين.

The row key is `<base58 address>/<slot-id-one's-compliment-hex-slot-0-prefixed-to-16-digits>`. بيانات الصف (row data) مضغوطة بهيكلة `TransactionByAddrInfo`.

إن الحصول على إطراء الشخص للفُتحة (Slot) يسمح بإدراج الفُتحات التي تضمن أن الفُتحة الأحدث مع المُعاملات التي تؤثر على العنوان سيتم إدراجها دائمًا أولاً.

لم تتم فهرسة عناوين Sysvar. مع ذلك، فإن البرامج المُستخدمة بشكل مُتكرر مثل التصويت (Vote) أو النظام (System) هي، ومن المُحتمل أن يكون لها صف لكل فُتحة (Slot) مُؤكدة.

### جدول بحث توقيع المُعاملة: `tx`

يقوم هذا الجدول بتعيين توقيع المُعاملة إلى الكتلة (block) المُؤكدة، والفهرس داخل تلك الكتلة.

مفتاح الصف (row key) هو توقيع المُعاملة بترميز base58. بيانات الصف عبارة عن هيكل مضغوط لمعلومات المُعاملة `TransactionInfo`.
