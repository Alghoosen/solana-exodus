---
title: خدمة القيل والقال (Gossip Service)
---

تعمل خدمة القيل والقال (Gossip Service) كبوابة للعقد في لوحة التحكم. ويستخدم المُدقّقون هذه الخدمة لتأكيد توافر المعلومات لدى جميع العقد في مجموعة ما. وتقوم الخدمة ببث معلومات باستخدام بروتوكول القيل والقال (gossip protocol).

## نظرة عامة على خدمة القيل والقال

تتشارك العقود باستمرار عناصر البيانات الموقع فيما بينها من أجل إدارة المجموعة. فهم، على سبيل المثال؛ يتشاركون معلومات الاتصال، وارتفاع ledger، والأصوات.

كل عشر من الثانية، ترسل كل عقدة رسالة "دفع" (push) و/أو رسالة "سحب" (pull). ومن الممكن أن تحصل رسائل الدفع والسحب على استجابات، ويمكن كذلك إعادة توجيه رسائل الدفع إلى آخرين في المجموعة.

ويعمل بروتوكول القيل والقال على منفذ UDP/IP معروف، أو منفذ في مدى متعارف عليه. وبمجرد أن يبدأ تمهيد مجموعة، تعلن العقد لبعضها البعض أين تجد نقطة نهاية القيل والقال الخاصة بها \(عنوان مقبس\).

## سجلات القيل والقال

تتم مشاركة السجلات بواسطة خدمة القيل والقال بشكل عشوائي، إلا أنه يتم توقيعها وترقيمها \(بختم زمني\) بحسب الحاجة لتكون ذات معنى بالنسبة للعقد التي تستقبلها. وفي حال تلقت عقدة ما سجلين اثنين من نفس المصدر، فإنها تقوم بتحديث نسختها الخاصة بالسجل ذي الختم الزمني الأحدث.

## واجهة خدمة القيل والقال

### رسالة الدفع

ترسل العقدة رسالة دفع لإعلام المجموعة بأن لديها معلومات لمشاركتها. وتقوم العقد بدورها بإرسال رسائل دفع إلى `PUSH_FANOUT` نظراء الدفع.

عند تلقي رسالة دفع، تقوم العقدة بتفحص الرسالة من أجل الكشف عن:

1. التكرار: إذا كانت الرسالة قد أرسلت من قبل، تقوم العقدة بإسقاط الرسالة وقد ترد بضغط رسالة الدفع `PushMessagePrune` إذا كانت موجهة من عُقدة مُحَصِّصة أدنى
2. بيانات جديدة: إذا كانت الرسالة جديدة بالنسبة للعُقدة

   - تقوم بتخزين المعلومات الجديدة بنسخة مُحدثة في معلومات المجموعة الخاصة بها و

     فرمتة أي قيمة قديمة سابقة

   - تقوم بتخزين الرسالة في `pushed_once` \(تستخدم للكشف عن التكرارات،

     وفرمتتها بعد `PUSH_MSG_TIMEOUT * 5` ملي ثانية\)

   - تُعيد إرسال الرسالة إلى أقران الدفع الخاصة بها

3. إنتهاء الصلاحية: تقوم العقد بإسقاط رسائل الدفع الأقدم من `PUSH_MSG_TIMEOUT`

### أقران الدفع، رسالة الضغط

تقوم العقدة باختيار أقران الدفع الخاصة بها بشكل عشوائي من المجموعة النشطة من الأقران المعروفين. وتحتفظ العقدة بهذا الاختيار لمدة طويلة نسبيًا. عندما يتم تلقي رسالة تقليم، تقوم العُقدة بإسقاط قرين الدفع الذي قام بإرسال التقليم. ويعتبر التقليم مُؤشرًا على وجود مسار حِصَّة أعلى وزنًا إلى تلك العُقدة من الدفع المُباشر.

يتم الإحتفاظ بمجموعة أقران الدفع مُحدثة من خلال تدوير عُقدة جديدة في المجموعة كل `PUSH_MSG_TIMEOUT/2` جزء من الثانية.

### رسالة السحب

تقوم العُقدة بإرسال رسالة سحب لسؤال المجموعة ما إذا كانت هناك أي معلومات جديدة. ويتم إرسال رسالة سحب إلى نظير واحد بشكل عشوائي وتشكل فِلتر بلوم (Bloom filter) الذي يُمثل الأشياء التي تمتلكها مُسبقًا. وتتكرر العُقدة التي تستلم رسالة سحب فوق قيمها، وتقوم بإنشاء إستجابة سحب للأشياء التي تفتقر إلى الفلتر وتتناسب مع الرسالة.

تقوم العُقدة ببناء فِلتر سحب بلووم (pull Bloom filter) من خلال تكرار القِيَم الحالية و القِيَم التي تمت فرمتتها مُؤخرًا.

تتعامل العُقدة مع عناصر في إستجابة السحب (pull response) بنفس الطريقة التي تتعامل فيها مع البيانات الجديدة في رسالة الدفع (push message).

## الفرمتة (Purging)

تحتفظ العُقَد بنسخ سابقة من القِيَم \(التي تم تحديثها بواسطة سحب أو دفع\) والقِيَم مُنتهية الصلاحية \(القِيَم الأقدم من `GOSSIP_PULL_CRDS_TIMEOUT_MS`\) في `purged_values` \(الأشياء المُمتلكة حديثًا\). تقوم العُقَد بفرمتة `purged_values` القِيَم الأقدم من `5 * GOSSIP_PULL_CRDS_TIMEOUT_MS`.

## هجمات الخسوف (Eclipse Attacks)

يعد هجوم الخسوف مُحاولة الإستيلاء على مجموعة إتصالات عُقدة بواسطة بنقاط نهاية الخصومة.

هذا الأمر هام بالنسبة لتطبيقنا الطرق التالية.

- تقوم رسائل السحب باختيار عقدة عشوائية من الشبكة. هجوم الخسوف على _pull_ يتطلب تأثير المُهاجم على الإختيار العشوائي بطريقة يتم فيها إختيار العُقَد العدائية فقط للسحب.
- تبقي رسائل الدفع مجموعة نَشِطة من العُقَد وتقوم بإختيار مُرسل معلومات (fanout) عشوائي لكل رسالة دفع. في حين يقوم هجوم الخسوف على _push_ بالتأثير على قائمة الإختيار النَشِطة، أو الإختيار العشوائي لمُرسل المعلومات.

### الزمن والأوزان القائمة على الحِصَّة

يتم حساب الأوزان بناء على زمن آخر إختيار لها `time since last picked` والسجل الطبيعي `natural log` لوزن الحِصَّة `stake weight`.

يسمح أخذ اللوغاريتم الطبيعي `ln` وزن الحِصَّة بإعطاء جميع العُقَد فرصة أكثر عدلًا لتغطية الشبكة في مُدة معقولة من الزمن. يُساعد ذلك في جعل أكبر فرق مُمكن في وزن الحِصَّة `stake weight` أكثر إستقرارًا بين العُقَد. بهذه الطريقة سيكون على العُقدة ذات وزن الحِصَّة المُنخفض `stake weight` مُقارنة بعُقدة ذات وزن حِصَّة أكبر `stake weight` الإنتظار بضعة أضعاف اللوغاريتم الطبيعي للحِصَّة ln\(`stake`\) من الثواني قبل أن يتم إختيارها.

وليس هنالك من سبيل للخصم أن يقوم بالتأثير على هذه المعايير.

### رسالة السحب (Pull Message)

يتم إختيار عُقدة كهدف سحب بناءً على الأوزان الموصوفة أعلاه.

### رسالة الدفع (Push Message)

تقوم رسالة التقليم بإزالة خصم من إتصال مُحتمل.

تمامًا مثل رسالة الدفع _pull message_، يتم إختيار العُقَد إلى داخل المجموعة النَشِطة بناءً على الوزن.

## فُروق ملحوظة من PlumTree

بروتوكول الدفع النَشِط الموصوف هنا مبني على [Plum Tree](https://haslab.uminho.pt/sites/default/files/jop/files/lpr07a.pdf). والفروق الأساسية هي:

- لرسائل الدفع ساعة حائط مُوقّعة من قبل المصدر. بمجرد إنتهاء صلاحية ساعة الحائظ، يتم إسقاط الرسالة. ومن الصعب فرض حد للقفزة في أجواء عدائية.
- لا يتم تطبيق الدفع الكسول (Lazy Push) لأنه ما من طريقة واضحة لمنع الخصم من تزوير البصمة الرقمية للرسالة. من شأن إتباع نهج ساذج (naive approach) أن يسمح بإعطاء الأولوية للخصم من أجل السحب إستنادا إلى مُدخلاتهم.
