---
title: مخزن الكتلة (Blockstore)
---

عندما تصل كتلة (block) ما إلى النهائية، تشكل جميع الكتل من تلك الكتلة حتى نصل إلى كتلة مرحلة التكوين سلسلة خطية بالإسم المعروف، بلوكشاين. لكن حتى هذه النقطة، يجب على المُدقّق أن يحافظ على جميع السلاسل التي يحتمل أن تكون صالحة، ومُسَمَّاة بالإنقسامات أو الشوكات _forks_. يُمكن إيجاد وصف العملية التي تتشكل فيها الإنقسامات أو الشوكات بشكل طبيعي نتيجة لتدوير القائد في عملية توليد الإنقسامات أو الشوكات [fork generation](../cluster/fork-generation.md). بُنية بيانات مخزن الكتلة _blockstore_ الموصوف هنا هو حول كيفية تعامل المُدقّق مع هذه الإنقسامات أو الشوكات (forks) حتى يتم الإنتهاء من الكتل.

يسمح مخزن الكتلة للمُدقّق بتسجيل كل جزئية يُلاحظها على الشبكة، في أي ترتيب، طالما أن القِطَعة (shred) مُوقّعة بواسطة المُدير المُتوقّع لفُتحة مُعينة.

يتم نقل القِطَع (shreds) إلى مساحة مفتاح قابلة للتشعب أي للإنقسام أو الشوكة، وهي مجموعة الفتحة الرئيسية مكونة من `leader slot` + `shred index` \(داخل الفتحة\). يسمح ذلك بتخزين هيكل قائمة التخطي لبروتوكول Solana بكامله، دون إختيار مُسبق لإتباع أي إنقسام أو شوكة (fork)، أو إستمرارية مُدخلات ما أو متى تستمر فيها.

يتم تنفيذ طلبات الإصلاح القِطَع (shreds) الأخيرة من ذاكرة الوصول العشوائي (RAM) أو الملفات الحديثة، ومن سعة التخزين الأكثر عمقًا لللقِطَع (shreds) الأقدم، كما هو مُنفذ من قبل مخزن الكتلة الداعم للتخزين.

## وظائف مخزن الكتلة

1. الإستمرارية: يتواجد مخزن الكتلة في مُقدمة خط أنابيب عُقَد التَحَقُّق

   مُباشرةً وراء تأكيد إستلام وتوقيع الشبكة. ولكن

   إذا كانت القِطَعة (shred) المُستلمة مُتوافقة مع الجدول الزمني الرئيسي \ (أي تم التوقيع عليها من قبل

   قائد للفتحة المُشار إليها \)، فسيتم تخزينها على الفور.

2. الإصلاح: الإصلاح هو نفسه إصلاح النافذة أعلاه، ولكنه قادر على خدمة أي

   قِطَع (shreds) تم إستلامها. يقوم مخزن الكُتلة بتخزين القِطَع (shreds) مع التوقيعات،

   مما يُحافظ على سلسلة المنشأ.

3. الشوكات أو الانقسامات (Forks): يدعم مخزن الكتلة الوصول العشوائي إلى القِطَع (shreds)، لذا يُمكن أن يدعم

   حاجة المُدقّق للتراجع وإعادة التشغيل من نقطة تفتيش البنك.

4. إعادة التشغيل: بواسطة التقليم والاِنتِقَاء (pruning/culling) المُناسب، يُمكن إعادة تشغيل مخزن الكتلة من خلال

   التعداد المُرتب للمُدخلات من الفُتحة 0. منطق مرحلة الإعادة

   \(أي التعامل مع الإنقسامات أو الشوكات\) يجب أن يستخدم لأحدث المُدخلات في

   مخزن الكتلة.

## تصميم مخزن الكتلة (Blockstore Design)

1. يتم تخزين المُدخلات في مخزن الكتلة كأزواج القيمة المفتاحية، حيث يكون المفتاح هو فهرس الفُتحة المُتداخلة وفهرس القِطَعة (shred) للمُدخلة، والقيمة هي بيانات المُدخلة. مُلاحظة، تُعد مُؤشرات القِطَعة (shred) مبنية على صفر لكل فُتحة \(أي أنها أقرب إلى الفُتحة\).
2. يُحافظ مخزن الكتلة على البيانات الوصفية لكل فُتحة، في بنية `SlotMeta` وتحتوي على:

   - `slot_index` - فهرس هذه الفُتحة
   - `num_blocks` - عدد الكتل في الفُتحة\(المُستخدمة للتسلسل غلى فُتحة سابقة\)
   - `consumed` - فهرس أعلى قِطَعة `n`، أي أن لجميع `m < n`، هناك قِطَعة في هذه الفُتحة بفهرس قِطَعة مساوٍ لـ `n` \(أي أعلى فهرس قِطَعة مُتتالية\).
   - `received` - أعلى فهرس مُسْتَلَم للفُتحة
   - `next_slots` - قائمة الفُتحات المُستقبلية التي يُمكن أن تتسلسل إليها هذه الفُتحة. وتُستخدم عند إعادة بناء

     دفتر الأستاذ (ledger) لإيجاد نقاط الإنقسام أو الشوكات (forks) المُحتملة.

   - `last_index` - فهرس القِطَعة المُعَلَم كآخر قِطَعة في الفُتحة. هذه العلامة على قِطَعة (shred) سيتم إعدادها من قبل المُدير لفُتحة عندما يقومون بتحويل آخر قِطَعة في فُتحة ما.
   - `is_rooted` - صحيحة إذا وفقط إذا كانت كل كتلة من فُتحة...0 تُشكل سلسلة كاملة بدون أي فجوات. يمكننا إشتقاق is_rooted لكل فُتحة بإتباع القواعد التالية. لتكن فُتحة \(n\) فُتحة بفهرس `n`، وفُتحة \(n\).is_full\(\) صحيحة إذا كانت الفُتحة بفهرس `n` تمتلك كافة العلامات المُتوقعة لتلك الفُتحة. لنفترض أن is_rooted\(n\) الجملة التي تجعل "الفُتحة \(n\).is_rooted is صحيحة". إذًا:

     is_rooted\(0\) is_rooted\(n+1\) iff \(is_rooted\(n\) and slot\(n\).is_full\(\)

3. التسلسل - عندما تصل فُتحة جديدة `x` نقوم بالتحقق من عدد الكتل \(`num_blocks`\) لتلك الفُتحة الجديدة \(هذه المعلومات مرمّزة في القِطَعة\). نعرف بعد ذلك أن هذه الفُتحة الجديدة تتسلسل إلى فُتحة `x - num_blocks`.
4. الإشتراكات - يوم مخزن الكتلة بتسجيل مجموعة من الفُتحات التي تم "الإشتراك" فيها. وهذا يعني أن المُدخلات التي تتسلسل إلى هذه الفُتحات سوف يتم إرسالها من خلال قناة مخزن الكتلة للإستهلات بواسطة مرحلة الإعادة (ReplayStage). لمزيد من التفاصيل قم بمُراجعة واجهات برمجة تطبيقات متجر الكُتلة `Blockstore APIs`.
5. إشعارات التحديث - يقوم مخزن الكتلة بإشعار المُستمعين عندما يتم قلب slot\(n\).is_rooted من خطأ إلى صواب لأي `n`.

## واجهات برمجة تطبيقات متجر الكُتلة (Blockstore APIs)

يوفر مخزن الكتلة واجهة برمجة تطبيقات (API) مبني على الإشتراك والتي تستخدمها مرحلة الإعادة (ReplayStage) للسؤال عن المُدخلات التي تهتم بها. سيتم إرسال المُدخلات من خلال قناة يوفرها مخزن الكتلة. ويكون إشتراك واجهات برمجة التطبيقات (API's) كالتالي: 1. `fn get_slots_since(slot_indexes: &[u64]) -> Vec<SlotMeta>`: يُعيد الفُتحات الجديدة المُتصلة بأي عنصر من القائمة `slot_indexes`.

1. `fn get_slot_entries(slot_index: u64, entry_start_index: usize, max_entries: Option<u64>) -> Vec<Entry>`: يُعيد مُتجه المُدخلة للفُتحة التي تبدأ بـ `entry_start_index`، مُخفية النتيجة عند `max` إذا `max_entries == Some(max)`، وما عدا ذلك لا يكون هناك حد علوي على طول تجه الإعادة المفروض.

مُلاحظة: هذا يعني بصورة جميعة أن مرحلة الإعادة سوف تعرف الآن عندما تنتهي فُتحة ما، وتشترك بالفُتحة التالية والتي تهتم بها للحصول على المجموعة التالية من المُدخلات. سابقًا، كان يقع عبء تسلسل الفُتحات على مخزن الكتلة.

## التفاعل مع البنك

يُعَرَّض البنك لمرحلة الإعادة:

1. `prev_hash`: أي سلسلة إثبات تاريخ (PoH) يعمل عليها كما هو مُشار من قبل التجزئة الخاصة بآخر

   مُدخلة تمت مُعالجتها

2. `tick_height`: العلامات في سلسلة إثبات التاريخ (PoH) المُؤثقة حاليًا بواسطة هذا

   البنك

3. `votes`: مجموعة السجلات التي تحتوي: 1. `prev_hashes`: أي شيء بعد هذا التصويت يجب أن يتسلسل إلى PoH 2. `tick_height`: ارتفاع العلامة الذي تم طرح هذا التصويت عنده 3. فترة الإقفال `lockout period`: كم طول المُدة التي يجب أن يتم فيها مُراقبة السلسلة لتكون في دفتر الأستاذ (ledger) لكي

   يكون قادرًا على أن يتم إدراجها في السلسلة أسفل هذا التصويت

تستخدم مرحلة الإعادة واجهات برمجة تطبيقات متجر الكُتلة (Blockstore APIs) لإيجاد أطول سلسلة من المُدخلات والتي تستطيع أن ترتبط بالتصويت السابق. إذا كانت سلسلة المُدخلات تلك غير قادرة على الإرتباط بآخر صوت، فإن مرحلة الإعادة تقوم بإرجاع البنك إلى ذلك التصويت وتُعيد بناء السلسلة من هناك.

## تقليم مخزن الكُتلة (Pruning Blockstore)

بمُجرد أن تكون مُدخلات مخزن الكتلة قديمة كفاية، يُصبح تمثيل جميع الإنقسامات أو الشوكات (forks) المُمكنة أقل أهمية، ربما حتى أكثر تعقيدًا لإعادة البناء فور إعادة التشغيل. ولكن بمُجرد أن تصل أصوات مُدقّق ما لأقصى إقفال، يُمكن تقليم وحذف أي مُحتوى مخزن كتلة غير موجود على سلسلة إثبات لاتاريخ (PoH chain) لذلك التصويت.
