---
title: フォークの生成
---

ここでは、[リーダーの回転](leader-rotation.md)に伴って自然に発生するフォークについて説明します。

## 概要

ノードは交代でリーダーになり、状態の変化をコード化した PoH を生成します クラスタは、リーダーが接続されていた場合に生成されたで***あろう***ものを合成することで、リーダーとの接続が失われても、状態の変化を取り込まないようにすることができます。 これにより、可能なフォークの数は、リーダーのローテーションスロットの境界で発生する可能性のあるフォークの「ある／ない」のスキップリストに制限されます。 任意のスロットでは、1 つのリーダーのトランザクションのみが受け入れられます。

## メッセージ フロー

1. 取引は現在のリーダーによって取り込まれています。
2. リーダーは有効なトランザクションをフィルタリングします。
3. リーダーは、その状態を更新する有効なトランザクションを実行します。
4. リーダーは、現在の PoH スロットに基づいて、トランザクションをエントリにパッケージします。
5. リーダーは、バリデータノードにエントリを送信します。\(サイン入りシュレッドで\)
   1. PoH ストリームには、リーダーの有効性とクラスター上での時間経過を示す空のエントリであるティックが含まれます。
   2. リーダーのストリームは、直近に観測されたリーダーの前のスロットまでの PoH を完了するのに必要なティックエントリから始まります。
6. バリデーターは、自分のセット内のピアやさらに下流のノードにエントリーを再送信します。
7. バリデータはトランザクションを検証し、その状態でトランザクションを実行します。
8. バリデータは状態のハッシュを計算します。
9. 特定の時刻、つまり特定の PoH ティックカウントになると、バリデータはリーダーに投票を送信します。
   1. 投票は、その"PoH tick count"で計算された状態のハッシュの署名です。
   2. 投票はゴシップでも伝わります。
10. リーダーは他のトランザクションと同様に投票を実行し、それをクラスターにブロードキャストします。
11. バリデーターは自分の投票とクラスターからの全投票を観察します。

## パーティション、フォーク

投票に対応する PoH ティックカウントで問題が発生することがあります。 次のリーダーは最後の投票スロットを観測していない可能性があり、生成された仮想 PoH エントリで自分のスロットを開始する可能性があります。 これらの空のティックは、クラスタ内のすべてのノードによって、hash/per/tick `Z`に対してクラスタ設定されたレートで生成されます。

投票枠内の PoH には 2 つのバージョンしかありません。現在のリーダーが生成した`T`刻みのエントリーを持つ PoH と、ただのティック（刻み）を持つ PoH です。 "ただのティック"版の PoH は、クラスター内のすべてのノードが前のスロットの最後のティックから導き出すことができる、仮想的な台帳と考えることができます。

検証者は、他の地点でのフォークを無視したり\(例：間違ったリーダから\)、フォークの原因となったリーダをスラッシュすることができます。

検証者の投票は、[タワー BFT](../implemented-proposals/tower-bft.md)で説明されている報酬を最大化するための欲張りな選択に基づいて行われます。

### バリデータの見解

#### タイムプログレッション

以下の図は、あるバリデータから見た PoH ストリームの時間経過に伴うフォークの可能性を表しています。 L1、L2 などはリーダーのスロットで、`E`s はそのリーダーのスロットでのそのリーダーからのエントリーを表します。 `x`s は時を表し、時間は図の下方向に流れます。

![フォークの生成](/img/fork-generation.svg)

`E`が同じスロットの 2 つのフォークに現れることはスラッシュ可能な条件なので、`E3`と`E3'`を観察しているバリデータは L3 をスラッシュして、そのスロットに`x`を安全に選ぶことができることに注意してください。 バリデータがフォークにコミットしたら、他のフォークはそのティックカウント以下のものは破棄して良いです。 どのスロットでも、バリデータはリーダーが提案する単一の "has entries "チェーンか "ticks only "チェーンを検討すれば良いです。 しかし、複数の仮想エントリーが前のスロットにリンクして重なることもあります。

#### 時間分割

PoH のティックカウントに対するリーダーのローテーションを、クラスターの状態をエンコードする仕事の時分割と考えると便利です。 次の表は、上記のフォークのツリーを時分割の台帳として表しています。

| リーダスロット       | L1  | L2  | L3  | L4  | L5  |
| :------------------- | :-- | :-- | :-- | :-- | :-- |
| データ               | E1  | E2  | E3  | E4  | E5  |
| 以前からのティック数 |     |     |     | x   | xx  |

なお、リーダースロット L3 では、リーダー L3 からのデータのみが受け付けられます。 L3 からのデータは、L3 が L2 のデータを観測しなかった場合、L2 以外のスロットへの"キャッチアップ"ティックを含むことがあります。 L4 と L5 の送信には、"ticks to prev"という PoH エントリが含まれます。

このようにネットワークのデータストリームを整理することで、ノードは再生、再起動、チェックポイントのために、正確なデータを台帳に保存することができます。

### リーダービュー

新しいリーダーがスロットを開始するときには、まず、新しいスロットを直近に観測・投票されたスロットとリンクさせるために必要な PoH\(ticks\) を送信しなければなりません。 リーダが提案するフォークは、現在のスロットと、リーダーが仮想ティックで投票した以前のフォークをリンクさせることになります。
