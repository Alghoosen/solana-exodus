---
title: ステーキングの委任と報酬
---

ステーカーは、台帳の検証を支援することで報酬を得ることができます。 ステーカーは、自分のステークをバリデータノードに委任することでこれを行います。 バリデータは台帳を再生し、ノードごとの投票アカウントに投票を送るという作業を行い、そのアカウントにステーキングを委任することができます。 クラスタの残りの部分は、フォークが発生したときにブロックを選択するために、これらのステーキング加重投票を使用します。 バリデータとステーカーの両者には、それぞれの役割を果たすための経済的なインセンティブが必要です。 バリデータにはハードウェアの補償が必要ですし、 ステーカーにはステーキングが削られるリスクの補償が必要です。 経済性については[staking rewards](../implemented-proposals/staking-rewards.md)を参照してください。 一方、このセクションでは、実装の基本的な仕組みについて説明します。

## ベーシックデザイン

一般的な考え方は、バリデータが投票アカウントを所有していることです。 投票アカウントはバリデータの投票を追跡し、バリデータが生成したクレジットをカウントし、バリデータ固有の状態を提供します。 投票アカウントは自分に委任されたステークキングを知らず、ステークキングの重みもありません。

別のステーキングアカウント \(ステーカーによって作成されたもの\)、 は、ステーキングが委任される投票口座に名前を付けます。 発生する報酬は、賭けたランポートの量に比例します。 ステーキングアカウントはステーカーのみが所有しています。 このアカウントに保存されているランポートの一部がステーキングです。

## パッシブデリゲーション

任意の数のステーキングアカウントは、投票アカウントを制御するIDからのインタラクティブなアクションやアカウントへの投票の提出なしに、1つの投票アカウントに委任することができます。

投票アカウントに割り当てられたステークの合計は、`StakeState::Stake::voter_pubkey`として投票アカウントの公開キーを持つすべてのステーキングアカウントの合計によって計算することができます。

## 投票とステーキングアカウント

報酬のプロセスは、2つのオンチェーンプログラムに分かれています。 投票プログラムは、ステーキングをスラッシング可能にするという問題を解決します。 ステーキングプログラムは、報酬プールの管理者として機能し、受動的な委任を提供します。 ステーキングプログラムは、ステーカーの代理人が台帳の検証に参加したことを示すと、ステーカーと投票者に報酬を支払う責任があります。

### VoteState

"VoteState"は、バリデータがネットワークに送信したすべての投票の現在の状態です。 "VoteState"には以下の状態が含まれています:

- `vote` - 提出された投票データ構造。
- `credit` - この投票プログラムが生成した報酬の総数。
- `root_slot` - 報酬に必要な完全なロックアウトコミットメントに達する最後のスロット。
- `コミッション` - ステーキングのステーキングアカウントによって要求された報酬に対して、この"VoteState"によって取られたコミッション。 これは報酬のパーセンテージの天井です。
- Account::lamports - コミッションから蓄積されたランポート。 これらは、ステーキングとしてカウントされません。
- `authorized_voter` - 投票を行う権限があるのはこの身元だけです。 このフィールドは、このIDによってのみ変更できます。
- `node_pubkey` - このアカウントで投票する Solana ノード。
- `authorized_collecter` - このアカウントのランポートを担当するエンティティの身元。 アカウントアドレスと署名者を分離します。

### VoteInstruction::Initialize\(VoteInit\)

- `account[0]` - RW - The VoteState.

  `VoteInit` carries the new vote account's `node_pubkey`, `authorized_voter`, `authorized_withdrawer`, and `commission`.

  他のステートメンバーがデフォルトに設定されました。

### VoteInstruction:Authorize\(Pubkey, VoteAuthorize\)

VoteAuthorize パラメータ \(`Voter` または `Withdrawer` \) 、に従って、新しい権限のある投票者または引き出しでアカウントを更新します。 トランザクションは、投票アカウントの現在の `authorized_voter` または `authorized_recovery` によって署名されなければなりません。

- `account[0]` - RW - The VoteState. `VoteState::authorized_voter` または `authorized_recoler` が `Pubkey` に設定されています。

### VoteInstruction::Vote\(Vote\)

- `account[0]` - RW - The VoteState. `VoteState::lockouts` と `VoteState::credit` は、ロックアウトのルールに応じて更新されます [Tower BFT](../implemented-proposals/tower-bft.md)。
- `account[1]` - RO - `sysvar::slot_hashes` いくつかの最新のスロットのリストと投票が検証されるハッシュのリスト。
- `account[2]` - RO - `sysvar::clock` 現在のネットワーク時間。スロットに表される時間、エポック。

### StakeState

"StakeState"は、"StakeState::Uninitialized"、"StakeState::Initialized"、"StakeState::Stake"、"StakeState::RewardsPool"の4つの形式のいずれかをとります 最初の3つの形式のみがステーキングで使用されますが、"StakeState::Stake"のみが興味深いものです。 すべての報酬プールは、ジェネシスで作成されます。

### StakeState::Stake

"StakeState::Stake"は、**ステーカー**の現在の委任の優先順位であり、以下の状態情報を含みます。

- Account::lamports - ステーキングに利用できるランポート。
- `stake` - 報酬を生成するためのステーキング額 \(ウォームアップとクールダウンの対象) Account::lamports以下。
- `voter_pubkey` - ランポートが委任されている VoteState インスタンスのパブキー。
- `credits_observed` - プログラムの生涯にわたって主張された総クレジット。
- `activated` - このステーキングが有効/委任されたエポック。 ウォームアップ後に全ステーキングがカウントされます。
- `deactivated` - このステーキングが無効化されたエポック。 アカウントが完全に無効化される前に、クールダウンの時期が必要になり、出金可能なステーキングが必要になります。
- `authorized_staker` - 委任トランザクション、アクティベーショントランザクション、および非アクティブトランザクションに署名する必要があるエンティティのパブキー。
- `authorized_coulder` - アカウントアドレスとは別に、このアカウントのランポートを担当している団体の身元、および権限のあるステーカーを示します。

### StakeState::RewardsPool

ネットワーク全体でのロックや交換時の競合を避けるために、256個のリワードプールがあらかじめ決められたキーの下でジェネシスの一部となっており、それぞれが"std::u64::MAX"クレジットを持ち、ポイントの価値に応じて交換を満たすことができるようになっています。

ステーキングとリワードプールは、同じ`ステークキング`プログラムで所有されるアカウントです。

### StakeInstruction::DelegateStake

ステーキングアカウントは、"Initialized"から"StakeState::Stake"の形に、または非活性化された(すなわち、完全にクールダウンされた)"StakeState::Stake"から活性化された"StakeState::Stake"に移動されます。 このようにして、ステーカーは自分のステーキングアカウントのランポートを委任する"vote account"と"validator node"を選択します。 トランザクションはステーキングの `authorized_staker` によって署名される必要があります。

- `account[0]` - RW - The StakeState::Stake instance. `StakeState::Stake::credits_observated` is initialized to `VoteState::credit`, `StakeState::Stake::voter_pubkey` is initialized to `account[1]`. これがステーキングの初期委任である場合、`StakeState::Stake::stake`はランポートのアカウントのバランスに初期化され、`StakeState::Stake::activated`は現在のBankエポックに初期化され、`StakeState::Stake::deactivated`は"std::u64::MAX"に初期化されます。
- `account[1]` - R - The VoteState instance.
- `account[2]` - R - sysvar::clock account, current Bank エポックに関する情報を伝えます。
- `account[3]` - R -" sysvar::stakehistory"アカウントは、ステーキングの履歴に関する情報を運びます。
- `account[4]` - R-"stake::Configアカウント"、"ウォームアップ"、"クールダウン"、"スラッシュ"設定を実行します。

### StakeInstruction::Authorize\(Pubkey, StakeAuthorize\)

StakeAuthorizeのパラメータ\(`Staker` or `Withdrawer`\)、に従って、新しい認可されたステーカーまたはウィズドローワーで、アカウントを更新します。 トランザクションは、ステーカー（原文スペルミス）アカウントの現在の`authorized_stake`rまたは`authorized_withdrawer`によって署名されなければなりません。 また、ロックアップされているステーキングは、ロックアップ期間が終了しているか、ロックアップされているカストディアンが取引に署名している必要があります。

- `account[0]` - RW - The StakeState.

  `StakeState::authorized_staker` または `authorized_collecter` が `Pubkey` に設定されています。

### StakeInstruction::Deactivate

ステーカーは、ネットワークから退会することができます。 そのためには、まず自分のステーキングを無効にして、クールダウンを待たなければなりません。 トランザクションはステーキングの `authorized_staker` によって署名されている必要があります。

- `account[0]` - RW - The StakeState::Stake instance that is deactivating.
- `account[1]` - R - 現在のエポックを運ぶ銀行からのsysvar::clockアカウント。

"StakeState::Stake::deactivated"は現在のエポック + クールダウンに設定されています。 アカウントの持分はその時点までにゼロになり、Account::lamports は引き出し可能になります。

### StakeInstruction::Withdraw\(u64\)

ステーキングアカウントには時間の経過とともにランポートが蓄積され、有効化されたステーキングを超えた分は出金することができます。 この取引には、ステーキングの`authorized_withdrawer`の署名が必要です。

- `account[0]` - RW - 撤退する"StakeState::Stake"です。
- `account[1]` - RW - 引き出されたランポートが入金されるべき口座。
- `account[2]` - R -sysvar::clock 現在のエポックを保持する銀行からのアカウントで、ステーキングを計算します。
- `account[3]` - R -sysvar::stake_history ステーキングのウォームアップ/クールダウンの履歴を保持する銀行の口座です。

## 設計上の利点

- すべてのステーカーに一票を。
- 報酬を請求するためにクレジット変数をクリアする必要はありません。
- 委任されたステーキングはそれぞれ独立して報酬を請求できます。
- 委任されたステーキングが報酬を請求した際に、作業に対する手数料が入金されます。

## コールフローの例

![パッシブステーキングコールフロー](/img/passive-staking-callflow.png)

## ステーキング報酬

バリデータ報酬制度の具体的な仕組みとルールについては、こちらをご覧ください。 報酬は、正しく投票しているバリデータに賭け金を委任することで得られます。 間違った投票をすると、そのバリデータの賭け金が[削られます](../proposals/slashing.md)。

### 基礎

ネットワークは、ネットワーク[インフレーション](../terminology.md#inflation)の一部から報酬を支払います。 1つのエポックで報酬を支払うために利用できるランポートの数は固定されており、相対的なステーキングの重みと参加状況に応じて、すべてのステーキングしたノードに均等に分配されなければなりません。 重み付けの単位は[ポイント](../terminology.md#point)と呼ばれます。

あるエポックの報酬は、そのエポックが終了するまで得られません。

各エポックの終わりに、そのエポックで獲得したポイントの総数が合計され、エポックのインフレーションの報酬部分を割るのに使われ、ポイント値が算出されます。 この値は、エポックとポイント値を対応付ける[sysvar](../terminology.md#sysvar)として銀行に記録されます。

還元時には、ステーキングプログラムは、エポックごとにステーキングで獲得したポイントをカウントし、それにエポックのポイント値を乗じ、その金額のランポートをリワードアカウントからステーキングアカウントと投票アカウントに、投票アカウントのコミッション設定に従って送金します。

### エコノミクス

エポックのポイント値は、ネットワーク全体の参加者数に依存します。 エポックへの参加が減少した場合、参加したエポックのポイント値は高くなります。

### クレジットの獲得

バリデータは最大ロックアウト数を超えた正しい投票1回につき、1票のクレジットを獲得します。つまり、バリデーターの投票アカウントがロックアウトリストからスロットを削除し、その投票がノードのルートになるたびに獲得するのです。

そのバリデータに委任したステーカーは、自分の賭け金に比例してポイントを獲得します。 獲得ポイントは投票クレジットとステーキングの積です。

### ステーキングのウォーミングアップ、クールダウン、引き出し

一度委任されたステーキングは、すぐに有効になるわけではありません。 まず、ウォームアップ期間を経る必要があります。 この期間中、ステーキングの一部は "effective”と見なされ、残りは"activating"と見なされます。 変更はエポックの境界で行われます。

これは"stake program"の、`config::warmup_rate`に反映されています。 \(現在の実装ではエポックごとに25%に設定されています\)。

各エポックごとにウォーミングアップされる賭け金の量は、前のエポックの有効な賭け金の合計、活性化する賭け金の合計、および賭け金プログラムの設定されたウォーミングアップ率の関数です。

クールダウンも同様です。 一度ステーキングが無効化されると、その一部は"effective"と見なされ、"deactivating"と見なされます。 賭け金がクールダウンされると、報酬を獲得し続け、スラッシングにさらされることになりますが、引き出しも可能になります。

ブートストラップの掛け金は、ウォームアップの対象にはなりません。

報酬は、そのエポックのステーキングの"有効"な部分に対して支払われます。

#### ウォームアップの例

エポックNで1,000個のステーキングが起動し、ネットワークのウォームアップ率が20%で、エポックNでのネットワーク全体のステーキングが2,000個と静止している状況を考えます。

エポックN+1では、ネットワークに投入可能な金額は400 \(20% of 2000\)、 エポックNでは、この例のステーキングは唯一投入されているステークであり、すべてのウォームアップルームを利用することができます。

| エポック | 効果的な | アクチべーティング |   総有効 | 合計起動中 |
|:---- | ----:| ---------:| -----:| -----:|
| N-1  |      |           | 2,000 |     0 |
| N    |    0 |     1,000 | 2,000 | 1,000 |
| N+1  |  400 |       600 | 2,400 |   600 |
| N+2  |  880 |       120 | 2,880 |   120 |
| N+3  | 1000 |         0 | 3,000 |     0 |

エポックNで2つの賭け金\(X and Y\) が有効になった場合、それらの賭け金に比例して20%の部分が与えられます。 各エポックにおいて、各ステーキングの"有効性"と"活性化"は、前のエポックの状態の関数です。

| エポック | X eff | X act | Y eff | Y act |   総有効 | 合計起動中 |
|:---- | -----:| -----:| -----:| -----:| -----:| -----:|
| N-1  |       |       |       |       | 2,000 |     0 |
| N    |     0 | 1,000 |     0 |   200 | 2,000 | 1,200 |
| N+1  |   333 |   667 |    67 |   133 | 2,400 |   800 |
| N+2  |   733 |   267 |   146 |    54 | 2,880 |   321 |
| N+3  |  1000 |     0 |   200 |     0 | 3,200 |     0 |

### 引き出し

いつでも、有効な賭け金と活性化させるための賭け金を超える賭け金のみを引き出すことができます。 つまり、ウォーミングアップ中は、事実上、賭け金を引き出すことはできません。 クールダウン時には、有効なステーキングを超えるトークンを引き出すことができます。 \(activating == 0\) 獲得したリワードは自動的にステーキングに加算されるため、引き出しは通常、ディアクティベート後にのみ可能です。

### ロックアップ

ステーキングアカウントは、ロックアップという概念をサポートしており、指定された時間までステーキングアカウントの残高を引き出すことができません ロックアップはエポックハイトとして指定されます。つまり、指定されたカストディアンによって署名されたトランザクションがない限り、ステーキングアカウントの残高が引き出し可能になる前にネットワークが到達しなければならない最小のエポックハイトです。 この情報は、ステーキングアカウントの作成時に収集され、ステーキングアカウントの状態の"Lockup"フィールドに保存されます。 許可されたステーキングホルダや引き出し人の変更も事実上の譲渡となるため、ロックアップの対象となります。
