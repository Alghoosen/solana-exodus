# RiP Curl: low-latency, transaction-oriented RPC

## 問題

Solanaの初期のRPC実装は、クラスターに送信されたばかりのトランザクションをユーザーが確認できるようにすることを目的として作成されました。 メモリ使用量を考慮して設計されているので、どんなバリデータでもDoS攻撃の心配なくAPIをサポートすることができます。

その後、同じAPIを使ってSolanaのエクスプローラーをサポートすることが必要になりました。 当初の設計では分単位の履歴しかサポートしていませんでしたが、代わりにローカルの"RocksDBインスタンス"にトランザクションのステータスを保存し、日単位の履歴を提供するように変更しました。 その後、"BigTable"を介して6ヶ月間に拡張しました。

このAPIは、変更を加えるたびに、静的なコンテンツを提供するアプリケーションに適したものとなり、トランザクション処理には適していませんでした。 クライアントはトランザクションの状況を通知するのではなく、ポーリングするため、確認時間が長いという誤った印象を与えてしまいます。 さらに、クライアントがポーリングできる内容は限られており、信頼できる特定のバリデータが投票した時点でトランザクションが確認されたと認識するなど、合理的なリアルタイム判断ができなくなっています。

## 提案された解決策

バリデータの"ReplayStage"を中心に構築された、ウェブフレンドリーでトランザクション指向のストリーミングAPIです。

クライアントの体験を向上させます。

* "WebAssemblyアプリ"からの直接接続をサポートします。
* クライアントは、投票数や投票者のステーキングウェイトなど、確認作業の進捗状況をリアルタイムで通知されます。
* 最も重いフォークが変更され、それが取引確認数に影響する場合、クライアントに通知することができます。

バリデータのサポートが容易になります。

* 各バリデータはある程度の数の同時接続をサポートしていますが、 それ以外のリソースに関する大きな制約はありません。
* トランザクションの状態はメモリ上に保存されず、ポーリングもできません。
* 署名がメモリに保存されるのは、希望するコミットレベルに達するまで、 あるいはブロックハッシュの有効期限が切れるまで、のいずれか遅い方です。

仕組み：

1. クライアントは、ウェブソケットなどの信頼性の高い通信チャネルを使用してバリデータに接続します
2. バリデータは署名を"ReplayStage"に登録します。
3. バリデータはトランザクションを"ガルフストリーム"に送り、ブロックハッシュが切れるまで(最も重いフォークでのみトランザクションが受理されるまでではない)、既知のすべてのフォークを再試行します。 ブロックハッシュが切れた場合、署名は登録解除され、クライアントに通知され、接続は終了します。
4. "ReplayStage"は、トランザクションの状態に影響を与えるイベントを検出すると、リアルタイムでクライアントに通知します。
5. トランザクションがルート化された(`CommitmentLevel::Max`)ことが確認されると、署名は登録解除され、サーバーはアップストリームチャネルを閉じます。
