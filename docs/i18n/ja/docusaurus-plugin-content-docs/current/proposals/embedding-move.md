---
title: Move言語の埋め込み
---

## 問題

Solanaでは、開発者がCやRustなどの汎用プログラミング言語でオンチェーンプログラムを書くことができますが、それらのプログラムにはSolana特有の仕組みが含まれています。 例えば、`"process_instruction(KeyedAccounts)"`関数を持つRustモジュールの作成を開発者に依頼するチェーンは他にありません。 実用的な場合はいつでも、Solanaはアプリケーション開発者に、よりポータブルなオプションを提供すべきです。

つい最近まで、人気のあるブロックチェーンでは、Solanaの超並列[ランタイム](../validator/runtime.md)の価値を公開できる言語を提供していませんでした。 例えば"Solidityコントラクト"は、共有データへの参照をコントラクトコードから分離していないため、決定論的な動作を確保するためにはシリアルで実行する必要があります。 実際には、最も積極的に最適化された"EVMベースのブロックチェーン"でも、ピーク時には1,200TPS程度となり、Solanaの能力のごく一部に過ぎないことがわかります。 一方、Libraプロジェクトでは、並列実行に適した"Move"というオンチェーンプログラミング言語を設計しました。 Moveプログラムは、Solanaのランタイムと同様に、すべての共有状態をアカウントに依存しています。

SolanaのランタイムとLibraの"Move VM"の設計上の最大の違いは、モジュール間の安全な呼び出しを管理する方法です。 Solanaはオペレーティングシステムのアプローチを取り、Libraはドメイン固有言語のアプローチを取りました。 ランタイムでは、モジュールがランタイムにトラップバックして、呼び出し元のモジュールが呼び出し先の所有するデータに書き込まれていないことを確認しなければなりません。 同様に、呼び出し側が完了すると、呼び出し側が呼び出し側のデータに書き込んでいないことを確認するために、再びランタイムにトラップバックする必要があります。 一方、Moveには高度な型システムが搭載されており、これらのチェックを"bytecode verifier"で実行することができます。 Moveのバイトコードは検証できるので、検証のコストは、モジュールがオンチェーンでロードされるときに一度だけ支払われます。 一方、ランタイムでは、モジュール間でトランザクションが交差するたびにコストが発生します。 この違いは、"Python"のような動的に型付けされた言語と、"Java"のような静的に型付けされた言語の違いに似ています。 Solanaのランタイムでは、アプリケーションを汎用のプログラミング言語で書くことができますが、それにはプログラム間をジャンプする際のランタイムチェックというコストがかかります。

この提案は、Move VMを以下のように埋め込む方法を定義しようとするものです。

- "Move内"でのモジュール間の呼び出しは、ランタイムのプログラム間のランタイムチェックは必要ありません。

  プログラム間のランタイムチェック

- Moveプログラムは他のSolanaプログラムの機能を利用でき、その逆も可能です。

  逆もまた然りです。

- Solanaのランタイムの並列性は、Moveと非Moveのバッチにさらされます。

  トランザクション

## 提案された解決策

### ソラナローダとしてのMove VM

Move VMは、`"MOVE_PROGRAM_ID"`という識別子でSolanaローダーとして組み込まれ、MoveモジュールがVMを`所有者`として`実行可能`とマークされるようにします。 これにより、モジュールはモジュールの依存関係をロードすることができ、また、Moveスクリプトの並列実行も可能になります。

Moveモジュールが所有するすべてのデータアカウントは、そのオーナーをローダである`"MOVE_PROGRAM_ID"`に設定しなければなりません。 Moveモジュールは、Solanaプログラムがアカウントデータをカプセル化するのと同じように、アカウントデータをカプセル化するので、Moveモジュールのオーナーはアカウントデータに埋め込まれなければなりません。 ランタイムはMove VMへの書き込みアクセスを許可し、Moveはモジュールのアカウントへのアクセスを許可します。

### Solanaプログラムとの相互作用

非Moveプログラムで命令を呼び出すためには、SolanaはMove VMを`"process_instruction()"`システムコールで拡張する必要があります。 これは`"process_instruction() Rust BPF"`プログラムと同じように動作します。
