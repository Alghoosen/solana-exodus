---
title: ブロックの確認
---

バリデータがPoHハッシュに投票する目的は2つあります。 まず、この投票はその時点までその台帳が有効であると信じていることを示します。 次に、ある高さには多くの有効なフォークが存在する可能性があるので、この投票はそのフォークを排他的に支持していることも示します。 この文書は前者のみを記述します。 後者は [Tower BFT](../implemented-proposals/tower-bft.md) に記述されています。

## 現在のデザイン

投票を開始するために、バリデータはまず投票先となるアカウントを登録します。 そして、そのアカウントに投票を送信します。 投票には、投票対象となるブロックの目盛りの高さが含まれます。 アカウントには32個の高さが保存されます。

### 問題

- バリデータだけが、自分の票を直接見つける方法を知っています。

  確認時間を計算するコンポーネントなど、その他のコンポーネントはバリデータのコードに組み込む必要があります。 バリデータのコードは、投票プログラムが所有するすべての口座を銀行に問い合わせます。

- 投票用紙にはPoHハッシュは含まれていません。 バリデータは任意のブロックをある高さで観測したことを投票するだけです。

- 投票用紙にはBankの状態を示すハッシュが含まれていません。 このハッシュがなければ、バリデータが取引を実行し、二重支出がないことを確認したという証拠がありません。

## 提案されたデザイン

### 最初はクロスブロック状態はありません

ブロックが生成された瞬間、リーダーは検証報酬に相当する数のトークンを含む"NewBlockトランザクション"を台帳に追加します。 これは事実上、マイニングプールからバリデーターにトークンを送る増分マルチシグ取引です。 アカウントは超過半数を達成するのに必要な票を集めるのに十分なスペースを割り当てるべきです。 バリデータが"NewBlockのトランザクション"を観測したとき、バリデータは自分の台帳の状態(Bankの状態) のハッシュを含む投票を提出することができます。 十分な票が集まったら、投票プログラムはトークンをバリデータに分散させ、それによってアカウントが削除されます。

#### ログの確認時間

"Bank"は、投票プログラムを認識する必要があります。 各取引の後、それが投票取引であるかどうかを確認し、投票取引であれば、その口座の状態を確認する必要があります。 その取引によって超過半数が達成された場合は、"NewBlockの取引"が提出されてからの時間を記録する必要があります。

### ファイナリティーと支払い

[Tower BFT](../implemented-proposals/tower-bft.md) は提案されたフォーク選択アルゴリズムです。 このアルゴリズムは、有効票の_スタック_が一定の深さに達し、その時点でロールバックが経済的に実行できなくなるまで、マイナーへの支払いを延期することを提案しています。 したがって、投票プログラムはTower BFTを実装することができます。 投票の指示は、ブロック間の状態を追跡できるように、グローバルなTowerアカウントを参照する必要があります。

## チャレンジ

### オンチェーン投票

これを実現するためにプログラムやアカウントを使うのは、ちょっと面倒です。 一番大変なのは、NewBlockにどれだけのスペースを割り当てるかを考えることです。 変数は、_アクティブセット_とそのバリデーターのステーキングの2つです NewBlockの投稿時にアクティブセットを計算すれば、スペースを確保すべきバリデータの数は前もってわかります。 しかし、新しいバリデータに古いブロックへの投票を許可する場合は、動的にスペースを割り当てる方法が必要になるでしょう。

同様に、リーダがNewBlockの時点でステークをキャッシュしておけば、投票プログラムが投票を処理する際にBankとやり取りする必要はありません。 もしそうしないのであれば、投票が行われるまで賭け金を浮かせておくという選択肢もあります。 バリデータが自分のステーキングアカウントを参照することは考えられますが、その場合は直近に確定したBankの状態のアカウントの値ではなく、現在のアカウントの値になります。 現在のところ、Bankは特定の時点のアカウントを参照する手段を提供していません。

### 以前のブロックへの投票の影響

ある高さのブロックへの投票は、そのフォークのそれ以下の高さのブロックすべてへの投票を意味するのでしょうか？ もしそうであれば、まだ超過半数に達していない全ブロックのアカウントを調べる方法が必要になります。 そうでなければ、バリデータはブロック報酬を得るために明示的に全ブロックに投票を送ることができます。
