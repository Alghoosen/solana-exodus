---
title: リペアサービス
---

## リペアサービス

"RepairService"は、"Turbine"などの一次通信プロトコルで配信できなかった欠落したシュレッドの回収を担当します。 後述の`Repair Protocols`で説明するプロトコルの管理を担当しています。

## チャレンジ:

1\) ネットワーク障害によりバリデーターが特定のシュレッダーを受信できない可能性があります。

2\) ブロックストアがスロット {1, 3, 5} のセットを含むシナリオを考えてみましょう。 このとき、ブロックストアはあるスロット7のシュレッドを受信し、各シュレッドbについてb.parent == 6となっているので、親子関係の6→&gt;7がブロックストアに保存されていることになります。 しかし、これらのスロットを"Blockstore"内の既存のバンクにチェーンする方法がないため、`Shred Repair`プロトコルはこれらのスロットを修復しません。 これらのスロットがたまたまメインチェーンの一部であった場合、このノードでのリプレイの進行が停止してしまいます。

## 修理関連のプリミティブ

エポックスロット: 各バリデーターは、 `エポックスロット` のさまざまな部分をゴシップで広告します。

- The `stash`: 完成したスロットのエポック長の圧縮セット。
- The `cache`: あるスロット`M`から始まる最新の`N`個の完了したスロットのランレングス・エンコーディング(RLE) で、`N`はMTUサイズのパケットに収まるスロットの数です。

ゴシップの`エポックスロット`は、バリデータがエポック内の完全なスロットを受信するたびに更新されます。 完了したスロットはブロックストアによって検出され、チャネルを介して"RepairService"に送信されます。 WindowServiceは未確認のエポックに対するシュレッドを拒否するため、スロット`Xが`完了するまでに、スロット`X`を含むエポックに対してエポックスケジュールが存在しなければならないことを知っておくことは重要です。

`N/2`個の完成したスロットごとに、最も古い`N/2`個のスロットが`cache`から`stash`に移されます。 RLEの基本値`M`も更新されなければなりません。

## リクエストプロトコルの修復

修復プロトコルは、Blockstoreのフォーク構造を進展させるために最善の試みを行っています。

上記の課題を解決するための異なるプロトコル戦略です。

1. 破片修理\(Addresses Challenge \#1\): 最も基本的な修復プロトコルであり、台帳の"穴"を検出して埋めることを目的としています。 "Blockstore"は最新のルートスロットを追跡します。 "RepairService"は、ルートスロットから始まるブロックストア内の全てのフォークを定期的に反復し、欠損した細片の修復要求をバリデータに送信します。 1回の反復で送れる修理要求は最大で`N個`である。 シュレッドの修復は、リーダーのフォークの重みに基づいてフォークの修復を優先すべきです。 バリデータは、自分の"EpochSlots"にそのスロットが完了したとマークしているバリデータにのみ修理依頼を送るべきです。 バリデータは、"turbine"での再送信に責任のある各スロットの細断ファイルの修復を優先しなければなりません。 タービンのシードは"リーダID"、"スロット"、"シュレッド"のインデックスに基づいているので、バリデータはどのシュレッドを再送する責任があるのかを計算することができます。

   注意: バリデータは、現在の検証可能なエポック \(バリデータがリーダーのスケジュールを把握しているエポック\) 内の細断処理のみを受け付けます。

2. Preemptive Slot Repair \(Addresses Challenge \#2\): このプロトコルの目的は、現在どの既知のフォークにも連鎖していない"orphan"スロットの連鎖関係を発見することです。 "Shred repair"は、リーダのフォーク荷重に基づいて、"orphan slots"の修復を優先すべきです。

   - "Blockstre"は、"orphan"スロットのセットを、別の列ファミリーで追跡します。
   - "RepairService"は、"blockstore"内の各"orphan"に対して定期的に`Orphan`リクエストを行います。

     `Orphan(orphan) request` - `orphan`は、リクエスト者がその親を知りたいと思っている"orphan slots"です。 `Orphan(orphan)`レスポンス - リクエストされた親の最初の`N`個のそれぞれに対する最高の細断値 `orphan`となります。

     応答`p`（`p`は親スロットの何らかのシュレッド）を受け取ると、バリデーターは次のようになります。

     - `p.slot` がまだ存在していない場合は、ブロックストアに空の `SlotMeta` を挿入します。
     - `p.slot` が存在する場合は、`parents` に基づいて `p` の親を更新します。

     注意: これらの空のスロットがブロックストアに追加されると、 `Shred Repair` プロトコルはそれらのスロットを埋めようとします。

     注意: バリデータは、現在の検証可能なエポック\(バリデータがリーダーのスケジュールを持っているエポック\) 内のシュレッドを含む回答しか受け付けません。

バリデータは、自分の"EpochSlots"でその"orphan"を完了したとマークしているバリデータに"orphan"のリクエストを送るようにしなければなりません。 そのようなバリデータが存在しない場合は、利害関係者を加味して無作為にバリデータを選択します。

## レスポンスプロトコルの修復

バリデータがシュレッド`S`のリクエストを受け取ると、自分が持っていればそのシュレッドで応答します。

バリデータが修復応答でシュレッドを受け取った場合、バリデータは`EpochSlots`をチェックし、ネットワークの`1/3以`下がこのスロットを完了したとマークしているかどうか< を確認します。 もし完了していれば、関連する"turbine path"を通じてこのシュレッドを再送信します。ただし、バリデータが以前にこのシュレッドを再送信していない場合に限ります。
