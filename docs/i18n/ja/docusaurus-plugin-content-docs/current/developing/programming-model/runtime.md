---
title: "ランタイム"
---

## プログラムの機能

ランタイムでは、オーナープログラムがアカウントの引き落としやデータの変更のみを許可します。 その後、プログラムは、クライアントが所有するアカウントを変更できるかどうかについての追加ルールを定義します。 System プログラムの場合は、トランザクションの署名を認識することで、ユーザーがランポートを転送することを許可します。 クライアントがキーペアの*秘密キー*を使用してトランザクションに署名したことを確認した場合、クライアントがトークンの転送を承認したことがわかります。

言い換えれば、あるプログラムが所有するアカウントのセット全体は、キーがアカウントのアドレスで、値がプログラム固有の任意のバイナリデータであるキーバリューストアとみなすことができます プログラムの作者は、プログラム全体の状態を、多数のアカウントとして管理する方法を決めることができます。

ランタイムは、トランザクションの各命令を実行した後、アカウントのメタデータを使用して、アクセスポリシーに違反していないことを確認します。 プログラムがポリシーに違反していた場合、ランタイムはトランザクション内のすべての命令によって行われたアカウントの変更をすべて破棄し、トランザクションを失敗とマークします。

### ポリシー

プログラムが命令を処理した後、ランタイムはプログラムが許可された操作のみを行い、その結果が"ランタイムポリシー"に従っているかどうかを検証します。

プロセスは次のとおりです。

- アカウントの所有者のみが所有者を変更できます。
  - また、アカウントが書き込み可能な場合に限ります。
  - また、そのアカウントが実行可能でない場合に限ります。
  - また、データがゼロ初期化されている場合や空の場合に限ります。
- プログラムに割り当てられていないアカウントは、その残高を減少させることができません。
- 読み取り専用のアカウントと実行可能なアカウントの残高は変更できません。
- データのサイズを変更できるのは、システムプログラムがアカウントを所有している場合のみです。
- アカウントのデータを変更できるのは、オーナーだけです。
  - そして、そのアカウントが書き込み可能であるかどうか。
  - そして、そのアカウントが実行可能でない場合です。
- 実行可能は一方通行(false->true)で、アカウントの所有者のみが設定できます。
- このアカウントに関連付けられている rent_epoch への変更はありません。

## 予算の計算

プログラムが計算資源を乱用するのを防ぐため、トランザクション内の各命令には計算バジェットが与えられます。 予算は、プログラムが様々な処理を行う際に消費される計算ユニットと、プログラムが超えてはならない境界から構成されています。 プログラムがバジェットをすべて消費したり、バウンドを超えたりすると、ランタイムはプログラムを停止し、エラーを返します。

以下の操作には計算コストがかかります。

- BPF 命令の実行
- システムコールの呼び出し
  - ログ
  - プログラムアドレスの作成
  - プログラム間での呼び出し
  - ...

プログラム間の呼び出しの場合、呼び出されたプログラムは親プログラムの予算を継承します。 呼び出されたプログラムが予算を消費したり、制限を超えたりすると、呼び出しチェーン全体と親プログラムが停止します。

現在の [計算 の予算](https://github.com/solana-labs/solana/blob/d3a3a7548c857f26ec2cb10e270da72d373020ec/sdk/src/process_instruction.rs#L65) は Solana SDK にあります。

たとえば、現在の予算が次のような場合:

```rust
max_units: 200,000,
log_units: 100,
log_u64_units: 100,
create_program address units: 1500,
invoke_units: 1000,
max_invoke_depth: 4,
max_call_depth: 64,
stack_frame_size: 4096,
log_pubkey_units: 100,
```

そして、プログラム

- 他に何もしない場合、"200,000 BPF"命令を実行できます。
- 2,000 件のログメッセージを記録できました。
- スタック使用量が"4k"を超えることはできません。
- BPF 呼び出し深度"64"を超えることはできません。
- クロスプログラム呼び出しのレベル"4"を超えることはできません。

計算機予算は、プログラムの実行に伴って段階的に消費されるため、予算の総消費量は、プログラムが実行する操作の様々なコストの組み合わせとなります。

プログラムの実行時には、計算バジェットがどれだけ残っているかを記録することができます。 See [debugging](developing/on-chain-programs/debugging.md#monitoring-compute-budget-consumption) for more information.

予算値は機能の有効化に条件付きです。 budget's [new](https://github.com/solana-labs/solana/blob/d3a3a7548c857f26ec2cb10e270da72d373020ec/sdk/src/process_instruction.rs#L97) 関数を見て、予算がどのように構成されているかを調べてみましょう。 [の機能](runtime.md#features) の仕組みと、 クラスタで有効になっている機能を理解するには、現在の予算の値を決定する必要があります。

## 新機能

Solana の進化に伴い、クラスターの動作やプログラムの実行方法を変更する新機能やパッチが導入されることがあります。 動作の変更は、クラスタのさまざまなノード間で調整されなければなりません。ノード間で調整が行われない場合、これらの変更はコンセンサスの崩壊を招くことになります Solana では、変更をスムーズに取り入れるために、ランタイムフィーチャーと呼ばれるメカニズムをサポートしています。

ランタイムフィーチャはエポック調整されたイベントで、クラスターに対する 1 つまたは複数の動作変更が発生します。 振る舞いを変えるような Solana への新しい変更は"フィーチャーゲート"で包まれ、デフォルトでは無効化されます。 Solana ツールを使用して機能を有効にすると、保留のマークが付き、保留のマークが付いた機能は次のエポックで有効になります。

どの機能が有効化されるかを判断するには、[Solana のコマンドラインツール](cli/install-solana-cli-tools.md)を使用します。

```bash
"Solana"機能ステータス
```

問題が発生した場合は、まず、使用している Solana ツールのバージョンが、`solana cluster-version`で返されるバージョンと一致していることを確認します 一致していない場合は、正しい[ツールスイートをインストールします](cli/install-solana-cli-tools.md)。
