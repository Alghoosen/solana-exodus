---
title: Управление Форками
---

Ежедневная книга разрешена для форка в ячейках. Результирующая структура данных формирует дерево под названием _blockstore_. Когда валидатор интерпретирует блок-магазин, он должен поддерживать состояние для каждого ветка в цепочке. Мы называем каждый экземпляр _активного форка_. Ответственность за взвешивание этих форков лежит на проверяющем, чтобы в конечном итоге он мог выбрать ответ.

Валидатор выбирает форк, внеся голосование в слот лидера на этой ветке. Голосование совершает валидатор на время под названием _период блокировки_. Валидатор не может голосовать за другой форк до истечения этого срока блокировки. Каждый последующий голос по одному форку удваивает длительность периода блокировки. После определенной кластерной настройки количество голосов \(настоящее время 32\), длина периода блокировки достигает того, что называется _максимальная блокировка_. До достижения максимального лимита блокировки, валидатор имеет возможность дождаться, пока период блокировки закончится, а затем проголосовать за другой форк. Когда он голосует за другой форк, он выполняет операцию _отката_, при этом состояние возвращается к общей контрольной точке, а затем перепрыгивает вперёд к кончику ветки, на которую он только что проголосовал. Максимальное расстояние, которое можно откатить, называется _глубиной отката_. Глубина отката - это количество голосов, требуемое для достижения максимальной блокировки. Когда валидатор голосует, любые контрольные точки за пределами глубины отката становятся недоступными. То есть нет сценария, в котором валидатор должен будет откатиться обратно за пределы откатной глубины. Поэтому он может безопасно _подвержить_ недостижимым форкам и _squash_ все контрольные точки сверх глубины отката в корневой контрольной точке.

## Активные Форки

Активный форк - это последовательность контрольных точек, имеющая длину не менее одной длины по сравнению с глубиной отката. Самый короткий ответчик будет иметь длину в один раз больше, чем глубина отката. Например:

![Форки](/img/forks.svg)

Следующие последовательности _активные форки_:

- {4, 2, 1}
- {5, 2, 1}
- {6, 3, 1}
- {7, 3, 1}

## Очистка и разморозка

Валидатор может голосовать по любой контрольной точке дерева. На диаграмме выше это каждый узел, за исключением листьев дерева. После голосования, валидатор подбрасывает узлы, которые развиваются от расстояния дальше, чем глубина отката, и затем использует возможность минимизировать использование памяти путем размытия любых узлов в корневом узле.

Начиная с приведенного выше примера с глубиной отката 2, рассмотрите голосование по 5 против 6 голосов. Во-первых, голосование 5 голосов:

![Форки после обработки](/img/forks-pruned.svg)

Новый корень 2, и любые активные форки, которые не являются потомками из 2 готовы.

В качестве альтернативного варианта голосование по 6:

![Форки](/img/forks-pruned2.svg)

Дерево остается с корнем 1, так как активная ветка начиная с 6 составляет всего 2 контрольных точки из корня.
