---
title: Среда выполнения
---

## Среда выполнения

Среда выполнения - это процессор одновременных транзакций. Транзакции заранее указывают свои зависимости данных, а распределение динамической памяти является явным. Отделив программный код от состояния, в котором он работает, среда выполнения может управлять параллельным доступом. Транзакции, обращающиеся только к аккаунтам только для чтения, выполняются параллельно, тогда как транзакции, обращающиеся к аккаунтам с возможностью записи, выполняются последовательно. Среда выполнения взаимодействует с программой через точку входа с четко определенным интерфейсом. Данные, хранящиеся в аккаунте, являются массивом байтов непрозрачного типа. Программа имеет полный контроль над содержимым.

Структура транзакции определяет список публичных ключей и подписей для этих ключей и последовательный список инструкций, которые будут работать с состояниями, связанными с ключами аккаунта. Чтобы транзакция была зафиксирована, все инструкции должны выполняться успешно; при любом прерывании транзакция не может быть зафиксирована.

#### Структура аккаунта

Аккаунты поддерживают баланс лэмпорта и память для конкретных программ.

## Движок транзакций

Движок отображает открытые ключи для аккаунтов и направляет их на точку входа в программу.

### Выполнение

Транзакции группируются и обрабатываются в конвейере. TPU и TVU идут немного разным путем. Среда выполнения TPU гарантирует, что запись PoH происходит до фиксации памяти.

Среда выполнения TVU гарантирует, что проверка PoH происходит до того, как среда выполнения обработает какие-либо транзакции.

![Конвейер среды выполнения](/img/runtime.svg)

На этапе _выполнения_ загруженные аккаунты не имеют зависимостей данных, поэтому все программы могут выполняться параллельно.

Среда выполнения обеспечивает следующие правила:

1. Только _программа-владелец_ может изменять содержимое аккаунты. Это означает, что при назначении вектор данных гарантированно равен нулю.
2. Общие остатки на всех счетах равны до и после выполнения транзакции.
3. После выполнения транзакции остатки на счетах только для чтения должны быть равны остаткам до транзакции.
4. Все инструкции в транзакции выполняются атомарно. В случае сбоя все изменения аккаунта отменяются.

Выполнение программы включает сопоставление публичного ключа программы на точку входа, которая берет указатель на транзакцию и массив загруженных аккаунтов.

### Интерфейс SystemProgram

Интерфейс лучше всего описывается `Instruction::data`, которую кодирует пользователь.

- `CreateAccount` - позволяет пользователю создать аккаунт с выделенным массивом данных и назначить его программе.
- `CreateAccountWithSeed` - аналогично `CreateAccount`, но адрес нового аккаунта получен от
  - pubkey аккаунта финансирования,
  - мнемоническая строка (seed), и
  - pubkey программы
- `Assign` - позволяет пользователю назначить существующий аккаунт для программы.
- `Transfer` - перемещает лэмпорты между аккаунтами.

### Обеспечение безопасности программы

Для правильной работы блокчейна код программы должен быть устойчивым к вводу пользователей. Вот почему в этом проекте программный код является единственным кодом, который может изменять состояние массива байтов данных в назначенных ему аккаунтах. Это также причина, по которой `Assign` или `CreateAccount` должны обнулить данные. В противном случае у программы не было бы возможности отличить недавно назначенные данные аккаунта от изначально сгенерированного перехода состояния без каких-либо дополнительных метаданных из среды выполнения, чтобы указать, что эта память назначена, а не генерируется изначально.

Чтобы передавать сообщения между программами, принимающая программа должна принять сообщение и скопировать состояние. Но на практике копия не нужна и нежелательна. Получающая программа может читать состояния, принадлежащие другим аккаунтам, не копируя их, и во время чтения она имеет гарантию состояния программы отправителя.

### Примечания

- Нет динамического распределения памяти. Клиент должен использовать `CreateAccount` инструкции для создания памяти перед передачей ее в другую программу. Эта инструкция может быть объединена в одну транзакцию с вызовом самой программы.
- `CreateAccount` и `Assign` гарантируют, что когда аккаунт назначен программе, данные аккаунта инициализированы нулем.
- Транзакции, которые привязывают аккаунт к программе или выделяют место, должны быть подписаны приватным ключом аккаунта, если только аккаунт не создается с помощью `CreateAccountWithSeed`, в этом случае не существует соответствующего закрытого ключа для адреса и публичного ключа аккаунта.
- После привязки к программе аккаунт не может быть переназначен.
- Среда выполнения гарантирует, что код программы является единственным кодом, который может изменять данные аккаунта, которой назначен аккаунт.
- Среда выполнения гарантирует, что программа может тратить только лэмпорты, которые находятся в назначенных ей аккаунтах.
- Среда выполнения гарантирует, что остатки на счетах сбалансированы до и после транзакции.
- Среда выполнения гарантирует, что все инструкции успешно выполнены после фиксации транзакции.

## Будущая работа

- [Продолжение и сигналы для длительных транзакций](https://github.com/solana-labs/solana/issues/1485)
