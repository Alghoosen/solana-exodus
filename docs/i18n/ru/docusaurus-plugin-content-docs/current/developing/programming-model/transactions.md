---
title: "Транзакции"
---

Выполнение программы начинается с добавления [транзакции](terminology.md#transaction) в кластер. Рантайм Solana запускает программу для автоматической обработки всех [инструкций](terminology.md#instruction) содержащихся в транзакции, по порядку.

## Анатомия транзакции

Этот раздел описывает бинарный формат транзакции.

### Формат транзакции

Транзакция содержит массив [compact-array](#compact-array-format) подписей, и [сообщение](#message-format). Каждый элемент в массиве подписей — это [цифровая подпись](#signature-format) заданного сообщения. Рантайм Solana проверяет чтобы количество подписей соответствовало числу в первых 8 битах [заголовка сообщения](#message-header-format). Рантайм так же верифицирует, что каждая подпись была подписана приватным ключом, соответствующим публичному ключу в том же индексе массива адресов аккаунта сообщения.

#### Формат подписи

Каждая цифровая подпись имеет двоичный формат ed25519 и занимает 64 байта.

### Формат сообщения

Сообщение содержит [заголовок](#message-header-format), за которым следует массив [адресов аккаунта](#account-addresses-format), затем идет хеш блока [blockhash](#blockhash-format), и далее массив [инструкций](#instruction-format).

#### Формат заголовка сообщения

Заголовок сообщения содержит три неподписанных 8-битных значения. Первое значение - это число необходимых подписей в родительской транзакции. Второе значение — это количество адресов соответствующего аккаунта, доступное только для чтения. Третье значение в заголовке сообщения - это число доступных только для чтения адресов аккаунта не требующих подписей.

#### Формат адресов аккаунта

Адреса, которые требуют подписи, появляются в начале массива адресов аккаунта, затем идут адреса, запрашивающими доступ на запись и далее идут аккаунты доступные только для чтения. Адреса, которые не требуют подписей, следуют за адресами, которые требуют, также с аккаунтами открытыми для чтения и записи, за которыми следуют открытые только для чтения аккаунты.

#### Формат хеша блока

В элементе blockhash содержится 32 байт SHA-256 хэш блока. Он используется как индикация, когда клиент последний раз просматривал блокчейн. Валидаторы могут отклонять транзакции, если блокхэш устарел.

### Формат инструкции

Инструкция содержит индекс id программы, затем идет компакт-массив индексов адресов аккаунта и далее компакт-массив непрозрачных 8-битных данных. Индекс id программы используется для идентификации on-chain программы, которая может интерпретировать непрозрачные данные. Индекс id программы - это неподписанный 8-битный индекс адреса аккаунта в массиве адресов аккаунта принадлежащего сообщению. Индексами адреса аккаунта являются неподписанные 8-битные индексы в том же самом массиве.

### Формат компакт-массива

Компакт-массив сериализируется как длинна массива, после чего следует каждый элемент массива. Длина массива - это специальная многобайтная кодировка под названием compact-u16.

#### Формат Compact-u16

Compact-u16 — многобайтовая кодировка 16 бит. Первый байт содержит нижние 7 бит значения в его нижних 7 битах. Если значение над 0x7f, устанавливается высокий бит, а следующие 7 битов значения помещаются в нижние 7 бит второго байта. Если значение над 0x3fff, устанавливается высокий бит и оставшихся 2 бита значения помещаются в нижние 2 бита третьего байта.

### Формат адресов аккаунта

Адрес аккаунта - это 32 байта произвольных данных. Когда адрес требует цифровой подписи, рантайм интерпретирует его как публичный ключ ил пары ключей ed25519.

## Инструкции

Каждая [инструкция](terminology.md#instruction) указывает одну программу, a подмножество аккаунтов транзакций, которые должны быть переданы программе, и массива байт, который так же передается программе. Программа интерпретирует массив данных и оперирует аккаунтами, указанными ее инструкциями. Программа может возвращать успешный результат или код ошибки. В случае ошибки происходит немедленный откат всей транзакции.

Обычно программа предоставляет вспомогательные функции для построения инструкций, которые они поддерживают. Например, системная программа предоставляет следующую вспомогательную функцию Rust для создания инструкции [`SystemInstruction::CreateAccount`](https://github.com/solana-labs/solana/blob/6606590b8132e56dab9e60b3f7d20ba7412a736c/sdk/program/src/system_instruction.rs#L63):

```rust
pub fn create_account(
    from_pubkey: &Pubkey,
    to_pubkey: &Pubkey,
    lamports: u64,
    space: u64,
    owner: &Pubkey,
) -> Instruction {
    let account_metas = vec![
        AccountMeta::new(*from_pubkey, true),
        AccountMeta::new(*to_pubkey, true),
    ];
    Instruction::new(
        system_program::id(),
        &SystemInstruction::CreateAccount {
            lamports,
            space,
            owner: *owner,
        },
        account_metas,
    )
}
```

Которую можно найти здесь:

https://github.com/solana-labs/solana/blob/6606590b8132e56dab9e60b3f7d20ba7412a736c/sdk/program/src/system_instruction.rs#L220

### Id программы

Содержащееся в инструкции [id программы](terminology.md#program-id) какая программа будет обрабатывать данную инструкцию. Владелец аккаунта программы определяет какой загрузчик должен использоваться для загрузки и выполнения программы, а данные содержат информацию о том, как рантайм будет запускать программу.

В случае [развернутых программ BPF ](developing/deployed-programs/overview.md), владельцем является BPF загрузчик и данные учетной записи содержат байткод BPF.  Аккаунты программ навсегда помечены как исполняемые загрузчиком сразу после успешной установки. Рантайм отклонит транзакции, которые определяют программы, которые не являются исполняемыми.


В отличии от развернутых программ Bpf, [встроенные](developing/builtins/programs.md) программы обрабатываются иначе и собираются непосредственно в рантайме Solana.

### Аккаунты

Аккаунты, упомянутые инструкцией, представляют on-chain состояние и служат как входами, так и выходом программы. Подробнее об аккаунтах можно найти в разделе [Аккаунты](accounts.md).

### Данные инструкции

Каждая инструкция содержит массив байтов общего назначения, который передается программе вместе с аккаунтами. Содержимое данных инструкции специфично конкретной программе и обычно используется для передачи тех операций, которые должна выполнять программа, и любую дополнительную информацию, которую могут понадобиться эти операции в дальнейшем и помимо той, что содержат аккаунты.

Программы вольны выбирать кодировку информации в байтовом массиве данных инструкции. Выбор метода кодирования данных должен учитывать перекрытие декодирования, поскольку этот шаг выполняется on-chain программой. Было отмечено, что некоторые общие кодировки (например, двоичный код Rust) очень неэффективны.

Ренализация токена [Solana Program Library's Token program](https://github.com/solana-labs/solana-program-library/tree/master/token) представляет один из примеров того как данные инструкции могут быть кодированы эффективно, однако отметьте что этот метод поддерживает только типы фиксированного размера. Токен использует трест [Pack](https://github.com/solana-labs/solana/blob/master/sdk/program/src/program_pack.rs) для кодирования/декодирования данных инструкций и для инструкций токена, и для состояния аккаунта токена.

## Подписи

Каждая транзакция явно перечисляет все публичные ключи аккаунта, на которые ссылаются инструкции транзакции. Подмножество этих публичных ключей сопровождается подписью транзакции. Эти подписи показывают on-chain программам, что владелец аккаунта авторизовал транзакцию. Обычно программа использует авторизацию, чтобы разрешить дебетование аккаунта или изменение его данных. Дополнительная информация о том, как авторизация взаимодействует с программой может быть найдена в [Аккаунтах](accounts.md#signers)


## Последний Blockhash

Транзакция включает в себя недавний [ блокхэш](terminology.md#blockhash), чтобы предотвратить дублирование и дать транзакциям время жизни. Любая транзакция, полностью идентичная предыдущей, будет отклонена, а добавление актуального блокхэша позволяет, например, нескольким транзакциям повторить одно и то же действие. Транзакции также имеют время жизни, определяемое блокхэшем (blockhash), так любые транзакции, чей blockhash устарел будут отклонены.
