---
title: "Рантайм"
---

## Возможности программ

Рантайм только позволяет программе-владельцу дебетовать счет или изменять его данные. Затем программа определяет дополнительные правила для того, чтобы клиент мог изменять свои аккаунты. В случае System-программы, она позволяет пользователям передавать балансы, распознавая подписи транзакций. Если она видит что клиент подписал транзакцию с помощью _приватного ключа_, то понимает, что клиент авторизовал передачу токенов.

Другими словами, весь набор аккаунтов, принадлежащих данной программе, можно рассматривать как хранилище типа ключ-значение, где ключом является адрес аккаунта, а значение - это произвольные бинарные данные, специфические для конкретной программы. Автор программы может решить, как управлять всем состоянием программы как возможно многими аккаунтами.

После выполнения рантаймом каждой из инструкций транзакции он использует метаданные аккаунта для проверки того, что политика доступа не была нарушена. Если программа нарушает политику доступа, рантайм снимает все изменения аккаунта, сделанные всеми инструкциями в транзакции, и помечает транзакцию как неудачную.

### Политика

После того, как программа обработала инструкцию, рантайм проверяет, что программа выполнила только доступные ей операции, и что результаты придерживаются политики рантайма.

Эта политика заключается в следующем:

- Только владелец аккаунта может изменить владельца.
  - И только если аккаунт доступен для записи.
  - И только если аккаунт не является исполняемым
  - И только если данные инициализированы нулевым значением или пусты.
- Баланс аккаунта, не привязанного к программе, не может быть понижен.
- Баланс только для чтения и исполняемых аккаунтов не может измениться.
- Только системная программа может изменять размер данных и только если системная программа владеет аккаунтом.
- Только владелец может изменять данные аккаунта.
  - И только если аккаунт доступен для записи.
  - И только если аккаунт не является исполняемым.
- Исполняемый является односторонним (false->true) и может его установить только владелец аккаунта.
- Ни одно изменение rent_epoch не связано с этим аккаунтом.

## Бюджет Вычислений

Чтобы не допустить чрезмерного использования программой вычислительных ресурсов, каждой инструкции в транзакции предоставляется вычислительный бюджет. Бюджет состоит из вычислительных единиц, которые потребляются при выполнении программой различных операций и задают границы, которые программа не может превысить. Когда программа потребляет весь свой бюджет или превышает ограничение расхода, - рантайм останавливает программу и возвращает ошибку.

Для выполнения следующих операций требуются вычислительные расходы:

- Выполнение инструкций BPF
- Вызов системных вызовов
  - логирование
  - создание адресов программы
  - межпрограммные вызовы
  - ...

Для кросс-программных вызовов программы наследуют бюджет их родителей. Если вызванная программа расходует весь бюджет или превышает ограничения расхода, то останавливается выполнение всей связанной цепочки вызовов и родительской программы.

Текущий [бюджет вычислений](https://github.com/solana-labs/solana/blob/d3a3a7548c857f26ec2cb10e270da72d373020ec/sdk/src/process_instruction.rs#L65) можно найти в Solana SDK.

Например, если текущий бюджет составляет:

```rust
max_units: 200,000,
log_units: 100,
log_u64_units: 100,
create_program address units: 1500,
invoke_units: 1000,
max_invoke_depth: 4,
max_call_depth: 64,
stack_frame_size: 4096,
log_pubkey_units: 100,
```

Тогда программа

- Может выполнить 200 000 BPF инструкций, если ничего больше не делается
- Может записать в лог 2000 сообщений
- Не может использовать больше 4к стека
- Не может превышать глубину BPF в 64 вызова
- Не может превышать 4 уровня кросс-программных вызовов.

Поскольку вычислительный бюджет расходуется постепенно, по мере выполнения программы общее потребление бюджета будет комбинироваться с различными затратами операций, которые он выполняет.

В рантайме программа может логировать, сколько вычислительного бюджета остается. See [debugging](developing/on-chain-programs/debugging.md#monitoring-compute-budget-consumption) for more information.

Бюджетные значения обусловлены функцией включения, посмотрите [новые](https://github.com/solana-labs/solana/blob/d3a3a7548c857f26ec2cb10e270da72d373020ec/sdk/src/process_instruction.rs#L97) функции бюджета вычислений, чтобы выяснить как устроен бюджет. Для определения значений текущего бюджета требуется понимание того, как работают [функции рантайма](runtime.md#features) и какие из этих функций включены в кластере.

## Новые возможности

По мере развития Solana могут быть добавлены новые функции или исправления, которые изменят поведение кластера и детали работы программ. Изменения в поведении должны быть скоординированы между различными узлами кластера, если узлы не скоординированы то эти изменения могут привести к нарушению консенсуса. Solana поддерживает механизм функций рантайма для обеспечения бесперебойного принятия изменений.

Функции рантайма - это скоординированные с эпохой события, когда одно или несколько изменений поведения появляется в кластере. Новые изменения в Solana, способные менять поведение, обернуты воротами функций и по умолчанию отключены. Инструменты Solana затем используются для активации функции, сначала помечая ее как ожидающую, после получения отметки как ожидающей функция будет активирована в следующей эпохе.

Чтобы определить, какие функции активированы, используйте инструменты [командной строки Solana ](cli/install-solana-cli-tools.md):

```bash
solana feature status
```

Если вы столкнетесь с проблемами, убедитесь, что версия инструментов Solana, которую вы используете соответствует версии, возвращенной из команды `solana cluster-version`. Если не соответствует [установите правильный набор инструментов](cli/install-solana-cli-tools.md).
