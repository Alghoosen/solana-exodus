---
title: Переход лидера к валидатору
---

Валидатор обычно тратит свое время на валидируя блоки. Однако, если стейкер делегирует свой стейк валидатору, то этот валидатор будет время от времени выбираться в качестве _слот лидера_. Являясь лидером слота, валидатор отвечает за производство блоков во время назначенного _слота_. Длительность слота занимает какое-то число предварительно настроенных _тиков_. Продолжительность этих тиков оценивается с помощью _PoH Recorder_, описанного ниже в этом документе.

## BankFork

BankFork отслеживает изменения в состоянии банка в определенном слоте. После того, как финальный тик был зарегистрирован, состояние банка замораживается. Любые попытки внести запись, будут отклонены.

## Валидатор

Валидатор работает с множеством различных параллельных ветвей состояния банка, пока не сгенерирует хэш PoH с высотой в пределах слота своего лидера.

## Лидер слота

Лидер слота генерирует блоки только на одном из форков, на последнем, за который проголосовали.

## PoH Recorder

Лидеры слотов и валидаторы используют PoH Recorder как для оценки высоты слота, так и для записи транзакций.

### PoH Recorder: Режим Валидатора

PoH Recorder работает как простая VDF (Verifiable Delay Function) когда выполняет валидацию. Он сообщает валидатору, когда ему нужно переключиться на роль лидера слота. Каждый раз, когда валидатор голосует за форк, он должен использовать последние [blockhash](../terminology.md#blockhash), чтобы повторно инициализировать VDF. Повторная инициализация решает две проблемы. Во-первых, он синхронизирует свой VDF с лидером, что позволяет ему более точно определять, когда начнется его слот. Во-вторых, если предыдущий лидер выходит из строя, то все временные метки учитываются в потоке PoH следующего лидера. Например, если при запуске лидера не хватает одного блока, то у создаваемого им блока должна быть длительность PoH, равная двум блокам. Более длительная продолжительность гарантирует, что следующий лидер не пытается отсечь все транзакции из слота предыдущего лидера.

### PoH Recorder: Режим Лидера

Лидер слотов использует PoH Recorder для записи транзакций, фиксируя свои позиции во времени. Хэш значение PoH должно быть получено из последнего блока предыдущего лидера. Если это не так, его блок не пройдет верификацию PoH и будет отклонен кластером.

PoH Recorder также служит для информирования лидера слота о завершении его слота. Лидер должен позаботиться о том, чтобы не изменять свой банк, если запись транзакции приведет к возникновению высоты PoH за пределами назначенного слота. Лидер, следовательно, не должен фиксировать изменения в аккаунте до тех пор, пока он не сгенерирует хэш PoH записи. Когда высота PoH выходит за пределы своего слота, любые транзакции находящиеся в его обработке могут быть отброшены или перенаправлены следующему лидеру. Перенаправление является предпочтительнее, поскольку оно минимизирует перегрузку сети, позволяя кластеру достигать более высокой пропускной способности TPS.

## Цикл валидатора

PoH Recorder обеспечивает переход между режимами. После воспроизведения реестра валидатор может работать до тех пор, пока Recorder не укажет, что он должен стать лидером слота. В качестве лидера узел может выполнять и записывать транзакции.

Этот цикл синхронизирован с PoH и делает синхронный запуск и остановку функционала слот лидера. После остановки TVU(Transaction Validation Unit) валидатор должен оказаться в таком же состоянии, как если бы другой лидер отправил ему тот же блок. Ниже приводится псевдокод цикла:

1. Запросить у LeaderScheduler следующий назначенный слот.
2. Запустить TVU на всех форках. 1. TVU отправит голоса за то, что, по его мнению, является «лучшим» форком. 2. После каждого голосования перезапустите PoH Recorder для запуска до следующего назначенного

   слота.

3. Запустить TPU(Transaction Processing Unit), если пришло время стать лидером слота. Направить в него данные последнего форка

   за который проголосовал TVU.

4. Производить записи до конца слота. 1. На время текущего слота, TVU не должен голосовать за другие форки. 2. После того, как слот закончился, TPU замораживает свой BankFork. После замораживания,

   TVU может возобновить голосование.

5. Перейти к пункту 1.
