---
title: Коррекция временных штампов
---

Каждый банк имеет временную метку, которая находится в системе Clock sysvar и используется для оценки блокировок аккаунтов, основанных на времени. Однако с самого начала это значение было основано на теоретической частоте слотов в секунду, а не на реальности, поэтому оно довольно неточно. Это создает проблему для блокировок, поскольку учетные записи не будут регистрироваться как свободные от блокировок в дату истечения срока блокировки (или в ближайшее время).

Время блокировки уже оценивается для кеширования в Blockstore и долгосрочного хранения с помощью [ валидатора timestamp oracle ](validator-timestamp-oracle.md); эти данные дают возможность более точно согласовать метку времени банка с реальным временем.

Общая схема предлагаемой реализации выглядит следующим образом:

- Исправьте каждую метку времени банка, используя метку времени, предоставленную валидатором.
- Обновите расчет временной метки, предоставленный валидатором, чтобы использовать взвешенное по ставкам медианное значение, а не среднее значение, взвешенное по ставкам.
- Ограничьте коррекцию отметки времени так, чтобы она не могла слишком сильно отклоняться от ожидаемой теоретической оценки

## Коррекция временных штампов

В каждом новом банке среда выполнения вычисляет реалистичную оценку временного штампа, используя данные валидатора timestamp-oracle. Отметка времени банка скорректирована на это значение если он больше или равен отметке времени предыдущего банка. То есть время никогда не должно идти назад, так что заблокированные аккаунты могут быть разблокированы путем исправления, но после разблокирования аккаунта никогда не могут быть повторно заблокированы с помощью корректировки времени.

### Расчет временного штампа, взвешенной по ставкам, медианы

Чтобы вычислить предполагаемый временной штамп для конкретного банка, среда выполнения сначала должна получить самые последние временные штампы голосования из активного набора средств проверки. Метод `Bank::vote_accounts()`обеспечивает состояние аккаунтов для голосования, и они могут быть отфильтрованы для всех аккаунтов, самый последний временной штамп который был предоставлен в пределах последней эпохи.

По каждому временному штампу голосования оценка текущего банка вычисляется с использованием целевого ns_per_slot эпохи для любой разницы между слотом банка и слотом временного штампа. Каждая оценка временного штампа связана со ставкой, делегированной этому аккаунту для голосования, и все временный штампы собираются для создания распределение временных штампов, взвешенных по ставкам.

Из этого набора выбирается медианная временного штампа, взвешенная по ставке, то есть временной штамп, при которой 50% ставки оценивает временной штамп больше или равным, а 50% ставки оценивает временной штамп меньшим или равным - как потенциальный исправленный временной штамп.

Эта средневзвешенный по ставкам временной штамп предпочтительнее, чем взвешенный по ставкам средний, потому что умножение ставки на предложенный временной штамп при вычислении среднего позволяет узлу с очень маленькой ставкой по-прежнему оказывает большое влияние на итоговый временной штамп, предлагая очень большой временной штамп большой или очень маленький. Например, используя предыдущий `calculate_stake_weighted_timestamp()` метод, узел с 0,00003% ставки, предлагающий временной штамп `i64:: MAX` может сдвинуть временной штамп на 97 тыс. лет вперед!

### Граничные временный штампы

Помимо предотвращения движения времени назад, мы можем предотвратить вредоносную активность, ограничив исправленный временной штамп до приемлемого уровня отклонения от теоретического ожидаемого времени.

Это предложение предлагает разрешить каждому временному штампу отклоняться до 25% от ожидаемого времени с начала эпохи.

Чтобы вычислить отклонение временного штампа, каждый банк должен зарегистрировать `epoch_start_timestamp` в системной переменной Clock sysvar. Это значение устанавливается в `Clock:: unix_timestamp` в первом слоте каждой эпохи.

Затем среда выполнения сравнивает ожидаемое время, прошедшее с начала эпохи, с предложенным истекшим временем на основе скорректированного временного штампа. Если исправленное время находится в пределах +/- 25% от ожидаемого, исправленный временной штамп принимается. В противном случае оно ограничено допустимым отклонением.
