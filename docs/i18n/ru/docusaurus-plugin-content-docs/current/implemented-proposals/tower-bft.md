---
title: Башня BFT
---

Этот дизайн описывает алгоритм Solana's _Tower BFT_. В нем рассматриваются следующие проблемы:

- Некоторые форки могут не быть приняты подавляющим большинством кластера, и избирателям необходимо оправиться от голосования на таких форках.
- Разные избиратели могут голосовать за множество форков, и каждый избиратель может видеть свой набор форков для голосования. Выбранные форки в конечном итоге должны объединиться для кластера.
- Голосование на основе вознаграждения сопряжено с определенным риском. Избиратели должны иметь возможность настраивать, какой риск они берут на себя.
- [стоимость отката](tower-bft.md#cost-of-rollback) должна быть вычислимой. Это важно для клиентов, которые полагаются на некоторую измеримую форму Последовательности. Затраты на нарушение согласованности должны быть вычислимыми и увеличиваться сверхлинейно для более старых голосов.
- Скорости ASIC различаются между узлами, и злоумышленники могут использовать ASICS с подтверждением истории, которые намного быстрее, чем остальная часть кластера. Консенсус должен быть устойчивым к атакам, использующим изменчивость скорости ASIC Proof of History.

Для краткости этот дизайн предполагает, что один избиратель со ставкой участия развернут в качестве отдельного валидатора в кластере.

## Время

Кластер Solana генерирует источник времени с помощью проверяемой функции задержки, которую мы называем [Proof of History](../cluster/synchronization.md).

Подтверждение истории используется для создания графика детерминированного круглого раунда для всех активных лидеров. В любой момент времени только 1 лидер, которого можно вычислить из самого реестра, может предложить форк. Для получения дополнительной информации см.[fork generation](../cluster/fork-generation.md) и [leader rotation](../cluster/leader-rotation.md).

## Блокировка

Цель блокировки - заставить валидатор зафиксировать альтернативные издержки для конкретного форка. Блокировки измеряются в слотах и поэтому представляют собой принудительную задержку в реальном времени, которую валидатор должен подождать, прежде чем нарушить обязательство по форку.

Валидаторы, которые нарушают локауты и голосуют за расходящиеся вилки внутри локаута, должны быть наказаны. Предлагаемое наказание состоит в том, чтобы сократить ставку валидатора, если одновременное голосование в рамках блокировки для не дочернего форка может быть доказано кластеру.

## Алгоритм

Основная идея этого подхода - складывать консенсусные голоса и двойные локауты. Каждый голос в стеке - это подтверждение форка. Каждая подтвержденный форк является предком расположенного над ним форка. Каждое голосование имеет ` блокировку ` в единицах слотов, прежде чем валидатор сможет отправить голосование, не содержащее подтвержденного форка в качестве предка.

Когда голос добавляется в стек, блокировки всех предыдущих голосов в стеке удваиваются \ (подробнее об этом см. [ Откат ](tower-bft.md#Rollback) \). С каждым новым голосованием валидатор фиксирует предыдущие голоса во все возрастающей блокировке. Имея 32 голоса, мы можем считать, что голос находится на уровне ` максимальной блокировки `, любые голоса с блокировкой, равной или превышающей `1<<32`, удаляются из очереди \ (FIFO \). Удаление голоса из очереди - это триггер для получения награды. Если голосование истекает до того, как оно будет удалено из очереди, оно и все голоса над ним выталкиваются \ (LIFO \) из стека голосов. Валидатору необходимо начать восстановление стека с этого момента.

### Откат

Перед тем, как голосование помещается в стек, извлекаются все голоса, приведшие к голосованию с меньшим временем блокировки, чем новое голосование. After rollback lockouts are not doubled until the validator catches up to the rollback height of votes.

После отката локауты не удваиваются, пока валидатор не догонит высоту отката голосов:

| голос | время голосования | блокировка | срок действия блокировки |
| -----:| -----------------:| ----------:| ------------------------:|
|     4 |                 4 |          2 |                        6 |
|     3 |                 3 |          4 |                        7 |
|     2 |                 2 |          8 |                       10 |
|     1 |                 1 |         16 |                       17 |

_Голос 5_ происходит в момент времени 9, и результирующее состояние

| голос | время голосования | блокировка | срок действия блокировки |
| -----:| -----------------:| ----------:| ------------------------:|
|     5 |                 9 |          2 |                       11 |
|     2 |                 2 |          8 |                       10 |
|     1 |                 1 |         16 |                       17 |

_Голос 6_ на момент 10

| голос | время голосования | блокировка | срок действия блокировки |
| -----:| -----------------:| ----------:| ------------------------:|
|     6 |                10 |          2 |                       12 |
|     5 |                 9 |          4 |                       13 |
|     2 |                 2 |          8 |                       10 |
|     1 |                 1 |         16 |                       17 |

На момент времени 10 новых голоса сравнялись с предыдущими. Но _голос 2 _ истекает в 10, поэтому, когда _ голос 7 _ в момент 11, применяются голоса включая и выше появится _голос 2 _.

| голос | время голосования | блокировка | срок действия блокировки |
| -----:| -----------------:| ----------:| ------------------------:|
|     7 |                11 |          2 |                       13 |
|     1 |                 1 |         16 |                       17 |

Блокировка для голосования 1 не увеличится с 16 до тех пор, пока в стеке не будет 5 голосов.

### Снятие и награда

Валидаторы должны быть вознаграждены за выбор форка, который выбирала остальная часть кластера, как можно чаще. Это хорошо согласуется с созданием награды, когда стек голосов заполнен и самый старый голос должен быть удален из очереди. Таким образом, за каждое успешное удаление из очереди должно создаваться вознаграждение.

### Стоимость отката

Стоимость отката _fork A_ определяется как стоимость с точки зрения времени блокировки для валидатора для подтверждения любой другого форка, которая не включает _fork A_ в качестве предка.

**Economic Finality**_ fork A _ можно рассчитать как потерю всех наград в результате отката _fork A_ и ее потомков, плюс альтернативная стоимость вознаграждения из-за экспоненциально растущей блокировки голосов, подтвердивших _fork A_.

### Пороговые значения

Каждый валидатор может независимо установить порог привязки кластера к форку до того, как этот валидатор зафиксирует форк. Например, при индексе стека голосов 7 блокировка составляет 256 единиц времени. Валидатор может отказать в голосовании и позволить голосам 0-7 завершиться, если только голосование по индексу 7 не имеет более 50% приверженности в кластере. Это позволяет каждому валидатору независимо контролировать степень риска для форка. Использование форков с более высокой частотой позволит валидатору заработать больше вознаграждений.

### Параметры алгоритма

Необходимо настроить следующие параметры:

- Количество голосов в стеке до выхода из очереди \(32\).
- Темпы роста блокировок в стеке \(2x\).
- Запуск блокировки по умолчанию \(2\).
- Пороговая глубина для минимальной фиксации кластера перед фиксацией в форке \ (8 \).
- Минимальный размер фиксации кластера на пороговой глубине \ (50% + \).

### Бесплатный выбор

«Свободный выбор» - это необязательное действие валидатора. Протокол не может кодировать и применять эти действия, поскольку каждый валидатор может изменять код и корректировать алгоритм. Валидатор, который максимизирует самовознаграждение по всем возможным вариантам будущего, должен вести себя таким образом, чтобы система была стабильной, а локальный жадный выбор должен приводить к жадному выбору из всех возможных вариантов будущего. Набор валидаторов, которые выбирают варианты нарушения протокола, должен быть привязан к отказу в обслуживании по их весу ставки. Два варианта выхода для валидатора:

- валидатор может опередить предыдущий валидатор в виртуальной генерации и отправить параллельный форк
- валидатор может приостановить голосование, чтобы наблюдать за несколькими форками перед голосованием

В обоих случаях у валидатора в кластере есть несколько форков для одновременного выбора, даже если каждій форк представляет разную высоту. В обоих случаях протокол не может определить, является ли поведение валидатора преднамеренным или нет.

### Выбор "Жадных" для параллельных форков

При оценке нескольких форков каждый валидатор должен использовать следующие правила:

1. Форки должны соответствовать правилу _ Порогового значения _.
2. Выберите форк, который максимизирует общее время блокировки кластера для всех родительских форков.
3. Выберите форк, который имеет наибольшую сумму комиссии за кластер.
4. Выбирайте последний форк с точки зрения PoH.

Комиссионные за транзакции кластера - это комиссии, которые переводятся в пул майнинга, как описано в разделе [ Вознаграждения за стейкинг ](staking-rewards.md).

## PoH ASIC Сопротивление

Голоса и блокировки растут экспоненциально, в то время как скорость ASIC линейна. Есть два возможных вектора атак с более быстрым ASIC.

### Цензура ASIC

Злоумышленник создает параллельный форк, который опережает предыдущих лидеров, пытаясь их подвергнуть цензуре. Форк, предложенный этим злоумышленником, будет доступен одновременно со следующим доступным лидером. Чтобы узлы выбрали эту вилку, она должна удовлетворять правилу _ жадного выбора _.

1. Форк должен иметь равное количество голосов для форка предка.
2. Форк не может быть настолько преобладающим, чтобы вызывать просроченные голоса.
3. Форк должен иметь больший размер комиссии за транзакции кластера.

Затем эта атака ограничивается цензурой сборов предыдущих лидеров и отдельных транзакций. Но он не может остановить кластер или уменьшить набор валидаторов по сравнению с параллельным форком. Цензура платы ограничивается платой за доступ, идущей к лидерам, но не к валидаторам.

### Откат ASIC

Злоумышленник генерирует параллельный форк из более старого блока, чтобы попытаться откатить кластер. В этой атаке параллельный форк конкурирует с форками, за которые уже проголосовали. Эта атака ограничивается экспоненциальным ростом блокировки.

- 1 голос имеет блокировку 2 слота. Параллельный форк должен располагаться как минимум на 2 слота впереди и производиться в 1 слоте. Поэтому требуется ASIC в 2 раза быстрее.
- 2 голоса имеют блокировку 4 слота. Конкуретнтный форк должен располагаться как минимум на 4 слота впереди и производиться в 2 слота. Поэтому требуется ASIC в 2 раза быстрее.
- 3 голоса имеют блокировку 8 слотов. Конкуретнтный форк должен располагаться как минимум на 8 слота впереди и производиться в 3 слота. Поэтому требуется ASIC 2.6 раза быстрее.
- 10 голоса имеют блокировку 1024 слотов. 1024/10 или 102.4x быстрее ASIC.
- 20 голосов имеют блокировку 2^20 слотов. 2^20/20, или 52,428.8x нужен быстрее ASIC.
