---
title: Сервис ремонта
---

## Сервис ремонта

RepairService отвечает за извлечение недостающих фрагментов, которые не удалось доставить с помощью основных протоколов связи, таких как Turbine. Он отвечает за управление протоколами, описанными ниже в разделе `Протокол ремонта`.

## Проблемы:

1\) Валидаторы могут не получить определенные фрагменты из-за сбоев в сети

2\) Рассмотрим сценарий, где blockstore содержит набор слотов {1, 3, 5}. Затем Blockstore получает фрагменты для некоторого слота 7, где для каждого из фрагментов b, b.parent == 6, поэтому отношение родитель-потомок 6 -&gt; 7 сохраняется в Blockstore. Однако невозможно связать эти слоты ни с одним из существующих банков в Blockstore, и поэтому протокол `Shred Repair` не будет восстанавливать эти слоты. Если эти слоты окажутся частью основной цепочки, это остановит прогресс воспроизведения на этом узле.

## Примитивы, связанные с ремонтом

Слоты эпохи: каждый валидатор отдельно рекламирует в gossip различные части `Epoch Slots`:

- `stash`: Сжатый на всю эпоху набор всех завершенных слотов.
- `cache`: Кодирование длин серий (RLE) последних `N` завершенных слотов, начиная с некоторого слота `M`, где `N` - количество слотов, в которых поместится в пакет размером с MTU.

`Epoch Slots` в gossip обновляются каждый раз, когда валидатор получает завершенный слот в пределах эпохи. Завершенные слоты обнаруживаются хранилищем блоков blockstore и отправляются по каналу в RepairService. Важно отметить, что мы знаем, что к тому времени, когда слот `X` завершится, расписание эпох должно существовать для эпохи, содержащей слот `X`, потому что WindowService будет отклонять фрагменты для неподтвержденных эпох.

Каждые `N/2` завершенных слотов, старые слоты `N/2` перемещаются из `cache` в `stash`. Базовое значение `M` для RLE также должно быть обновлено.

## Протоколы запроса на ремонт

Протокол ремонта делает все возможное, чтобы улучшить структуру разветвления Blockstore.

Различные стратегии протокола для решения вышеуказанных проблем:

1. Shred Repair \(см проблему \#1\): это самый простой протокол восстановления, предназначенный для обнаружения и заполнения «дыр» в реестре. Blockstore отслеживает последний корневой слот. RepairService будет периодически перебирать каждый форк в хранилище блоков, начиная с корневого слота, отправляя запросы на восстановление валидаторам для любых недостающих фрагментов. Он отправит максимум `N` запросов на восстановление за итерацию. Ремонт шредов должен отдавать приоритет ремонту форков в зависимости от размера форка лидера. Валидаторы должны отправлять запросы на восстановление только тем валидаторам, которые отметили этот слот как завершенный в своих EpochSlots. Валидаторы должны уделять приоритетное внимание ремонту шредов в каждом слоте, за который они отвечают на ретрансляцию через turbine. Валидаторы могут вычислить, за какие фрагменты они отвечают для ретрансляции, потому что сиды turbine основаны на id лидера, слоте и шред индексе.

   Примечание: Валидаторы будут принимать фрагменты только в пределах текущей проверяемой эпохи \(эпохи, для которой у валидатора есть расписание лидеров\).

2. Превентивный ремонт слота \(см. проблему \#2\): Целью этого протокола является обнаружение взаимосвязи цепочки «сиротских» слотов, которые в настоящее время не связаны ни с одним известным форком. Ремонт шредов должен отдавать приоритет восстановлению сиротских слотов в зависимости от размера форка лидера.

   - Blockstore будет отслеживать набор "сиротских" слотов в отдельном семействе столбцов.
   - RepairService будет периодически делать запросы `Orphan` для каждого из сирот в blockstore.

     `Orphan(orphan)` запрос - `orphan` - это сиротский слот, который просит узнать родителей в `Orphan(orphan)` ответе - Наивысшие фрагменты для каждого из первых `N` родителей запрошенного `orphan`

     После получения ответов `p`, где `p` это какой-то шред-фрагмент в родительском слоте, валидаторы:

     - Вставят пустой `SlotMeta` в blockstore для `p.slot`, если он не существует.
     - Если `p.slot` существует, обновят родителя `p` на основе `parents`

     Примечание: как только эти пустые слоты будут добавлены в blockstore, протокол `Shred Repair` должен попытаться заполнить эти слоты.

     Примечание: Валидаторы будут принимать фрагменты только в пределах текущей проверяемой эпохи \(эпохи, для которой у валидатора есть расписание лидеров\).

Валидаторы должны попытаться отправить orphan запросы валидаторам, которые отметили этот сиротский слот как завершенный в своих EpochSlots. Если таких валидаторов не существует, то случайным образом выбирается валидатор, отобранный по стейку.

## Протокол ответа на ремонт

Когда валидатор получает запрос на шред `S`, он отвечает шредом, если он у него есть.

Когда валидатор получает шред через ответ на ремонт, то проверяет `EpochSlots`, чтобы посмотреть, пометили ли в <= `1/3` сети этот слот как завершенный. Если это так, они повторно отправляют этот клочок через связанный с ним путь turbine, но только в том случае, если этот валидатор не ретранслировал этот шред раньше.
