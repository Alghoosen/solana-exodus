---
title: Проверка снапшота
---

## Проблема

Когда валидатор загружается из снапшота, ему нужен способ быстро проверить, что набор аккаунтов соответствует тому, что видит остальная часть сети. Потенциальный злоумышленник может сообщить валидатору неправильное состояние, а затем попытаться убедить его принять транзакцию, которая в противном случае была бы отклонена.

## Решение

В настоящее время хэш банка получается из хеширования дельта-состояния аккаунтов в слоте, которое затем комбинируется с предыдущим значением хэша банка. Проблема в том, что список хэшей будет расти в соответствии с количеством слотов, обрабатываемых цепочкой, и станет бременем как для успешной передачи, так и для успешной проверки.

Другим наивным методом может быть создание дерева Меркла состояния аккаунта. У этого есть обратная сторона, заключающаяся в том, что при каждом обновлении аккаунта дерево Меркла придется пересчитывать на основе всего состояния учетных записей всех текущих аккаунтов в системе.

Для проверки снапшота мы делаем следующее:

В хранилище аккаунтов ненулевых учетных записей lamport мы хешируем следующие данные:

- Владелец аккаунта
- Данные аккаунта
- Открытый ключ pubkey аккаунта
- Лэмпорт баланс аккаунта
- Форк, на котором хранится аккаунт

Используйте это результирующее хэш-значение в качестве входных данных для функции расширения, которая расширяет хэш в значение образа. Функция создаст 440-байтовый блок данных, где первые 32 байта являются хэш-значением, а в следующем - 32 байта генерируются из Chacha RNG с хэшем в качестве начального числа.

Затем образы аккаунтов объединяются с помощью xor. Предыдущее значение аккаунта будет преобразовано в состояние с помощью xor, а новое значение аккаунта также будет преобразовано с помощью xor в состояние.

Голосование и хэш-значения sysvar происходят с хэшем результирующего полного значения образа.

При загрузке валидатора, когда он загружается из снапшота, он будет проверять хэш-значение с набором аккаунтов. Затем он будет использовать SPV для отображения процента сети, проголосовавшей за указанное хэш-значение.

Полученное значение может быть проверено валидатором как как результат xor всех состояний текущего счета вместе.

Снапшот должен быть очищен от нулевых лэмпорт аккаунтов до создания и во время проверки, поскольку нулевые лэмпорт аккаунты не влияют на хэш-значение, но могут заставить банк- валидатор прочитать, что аккаунта нет, когда он действительно должен быть.

Может быть произведена атака на состояние xor, чтобы повлиять на его значение:

Таким образом, размер образа в 440 байт основывается на этой документации, избегая коллизий xor с 0 \(или с любым другим заданным битовым шаблоном): \[[https://link. pringer.com/content/pdf/10.1007%2F3-540-45708-9_19.pdf](https://link.springer.com/content/pdf/10.1007%2F3-540-45708-9_19.pdf)\]

В данном случае математика обеспечивает 128 битную безопасность:

```text
O(k * 2^(n/(1+lg(k)))
k=2^40 аккаунтов
n=440
2^(40) * 2^(448 * 8 / 41) ~= O(2^(128))
```
