/*
 * libsealevel is a C interface for the Sealevel virtual machine.
 * This version of the library bundles the interpreter and JIT implementations part of the Rust implementation of the Solana blockchain.
 *
 * Source code: https://github.com/solana-labs/solana
 *
 * ABI stability is planned, though this version makes no promises yet.
 * Passing resources between two different versions of this library is undefined behavior.
*/

#pragma once

/* Generated with cbindgen:0.23.0 */

/* Warning, this file is autogenerated by cbindgen. Don't modify this manually. */

#include <stdarg.h>
#include <stdbool.h>
#include <stddef.h>
#include <stdint.h>
#include <stdlib.h>

#define SEALEVEL_OK 0

#define SEALEVEL_ERR_INVALID_ELF 1

#define SEALEVEL_ERR_SYSCALL_REGISTRATION 2

#define SEALEVEL_ERR_CALL_DEPTH_EXCEEDED 3

#define SEALEVEL_ERR_UNKNOWN -1

/**
 * Sealevel virtual machine config.
 */
typedef struct sealevel_config sealevel_config;

typedef struct sealevel_executable sealevel_executable;

/**
 * The invoke context holds the state of a single transaction execution.
 * It tracks the execution progress (instruction being executed),
 * interfaces with account data,
 * and specifies the on-chain execution rules (precompiles, syscalls, sysvars).
 */
typedef struct sealevel_invoke_context sealevel_invoke_context;

/**
 * The map of syscalls provided by the virtual machine.
 */
typedef SyscallRegistry *sealevel_syscall_registry;

#ifdef __cplusplus
extern "C" {
#endif // __cplusplus

/**
 * Returns the error code of this thread's last seen error.
 */
int sealevel_errno(void);

/**
 * Returns a UTF-8 string of this thread's last seen error,
 * or NULL if `sealevel_errno() == SEALEVEL_OK`.
 *
 * Must be released using `sealevel_strerror_free` after use.
 */
const char *sealevel_strerror(void);

/**
 * Frees an unused error string gained from `sealevel_strerror`.
 * Calling this with a NULL pointer is a no-op.
 */
void sealevel_strerror_free(const char *str);

/**
 * Creates a new Sealevel machine config.
 */
sealevel_config *sealevel_config_new(void);

/**
 * Releases resources associated with a Sealevel machine config.
 */
void sealevel_config_free(sealevel_config *config);

/**
 * Drops an invoke context and all programs created with it.
 */
void sealevel_invoke_context_free(sealevel_invoke_context *this_);

/**
 * Loads a Sealevel program from an ELF buffer and verifies its SBF bytecode.
 *
 * Consumes the given syscall registry.
 */
sealevel_executable *sealevel_load_program(const sealevel_config *config,
                                           sealevel_syscall_registry syscalls,
                                           const char *data,
                                           size_t data_len);

/**
 * Compiles a program to native executable code.
 *
 * Sets `sealevel_errno`.
 */
void sealevel_program_jit_compile(sealevel_executable *program);

void sealevel_vm_create(void);

#ifdef __cplusplus
} // extern "C"
#endif // __cplusplus
